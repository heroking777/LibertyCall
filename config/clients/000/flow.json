{
  "version": "2.0",
  "updated_at": "2025-12-05",
  "description": "LibertyCall 会話フロー定義（修正版）",
  
  "phases": {
    "ENTRY": {
      "name": "初期フェーズ",
      "description": "通話開始時の最初のフェーズ",
      "transitions": [
        {
          "condition": "intent == 'NOT_HEARD' || intent == 'GREETING'",
          "target": "QA"
        },
        {
          "condition": "ENTRY_TRIGGER_KEYWORDS を含む",
          "target": "ENTRY_CONFIRM"
        },
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["004", "005"]
    },
    
    "ENTRY_CONFIRM": {
      "name": "エントリー確認",
      "description": "ホームページ/メールなどのキーワードが検出された場合の確認フェーズ",
      "transitions": [
        {
          "condition": "CLOSING_YES_KEYWORDS を含む",
          "target": "HANDOFF",
          "note": "営業フェーズへ"
        },
        {
          "condition": "CLOSING_NO_KEYWORDS を含む",
          "target": "END"
        },
        {
          "condition": "user_reply_received == True",
          "target": "QA",
          "note": "ユーザー返答あり"
        },
        {
          "condition": "user_reply_received == False",
          "target": "WAITING",
          "note": "ユーザー返答待ち"
        }
      ],
      "templates": ["006"],
      "wait_time_after": 1.8,
      "note": "テンプレート006発話後、1.8秒待機してからWAITINGフェーズへ"
    },
    
    "WAITING": {
      "name": "ユーザー返答待ち",
      "description": "AI発話後のユーザー返答を待つフェーズ（1.5〜2.0秒待機）",
      "transitions": [
        {
          "condition": "user_voice_detected == True",
          "target": "QA",
          "note": "ユーザー音声検知"
        },
        {
          "condition": "user_voice_detected == False && timeout",
          "target": "NOT_HEARD",
          "note": "返答なし → NOT_HEARD"
        }
      ],
      "templates": [],
      "human_wait_time": 1.8,
      "note": "1.8秒待機中にユーザー音声を検知したらQAへ、なければNOT_HEARDへ"
    },
    
    "NOT_HEARD": {
      "name": "聞き取れなかった",
      "description": "ユーザー返答が検知できなかった場合のフェーズ",
      "transitions": [
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["110"]
    },
    
    "QA": {
      "name": "質問応答フェーズ",
      "description": "通常の会話・質問への対応フェーズ",
      "transitions": [
        {
          "condition": "intent == 'SALES_CALL' && 初回",
          "target": "AFTER_085"
        },
        {
          "condition": "intent == 'END_CALL'",
          "target": "END"
        },
        {
          "condition": "intent == 'HANDOFF_REQUEST'",
          "target": "HANDOFF_CONFIRM_WAIT"
        },
        {
          "condition": "intent == 'INQUIRY_PASSIVE'",
          "target": "QA",
          "note": "温度の低いリード → QA継続（089/090を返す）"
        },
        {
          "condition": "その他（INQUIRY, UNKNOWN 含む）",
          "target": "QA",
          "note": "QA継続"
        }
      ],
      "templates": ["006_SYS", "010", "020", "021", "022", "023", "040", "041", "042", "060", "061", "062", "089", "090", "110"]
    },
    
    "AFTER_085": {
      "name": "フォローアップ",
      "description": "SALES_CALLや通常応答後のフォローフェーズ",
      "transitions": [
        {
          "condition": "intent == 'HANDOFF_REQUEST'",
          "target": "HANDOFF_CONFIRM_WAIT"
        },
        {
          "condition": "AFTER_085_NEGATIVE_KEYWORDS を含む",
          "target": "CLOSING"
        },
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["085"]
    },
    
    "CLOSING": {
      "name": "クロージング",
      "description": "最終確認・転送判断フェーズ",
      "transitions": [
        {
          "condition": "CLOSING_YES_KEYWORDS を含む",
          "target": "HANDOFF"
        },
        {
          "condition": "CLOSING_NO_KEYWORDS を含む",
          "target": "END"
        },
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["084"]
    },
    
    "HANDOFF": {
      "name": "ハンドオフ開始",
      "description": "担当者転送の開始フェーズ",
      "transitions": [
        {
          "condition": "自動遷移（060/061/062/104 を返した後）",
          "target": "HANDOFF_CONFIRM_WAIT"
        }
      ],
      "templates": ["060", "061", "062", "104"]
    },
    
    "HANDOFF_CONFIRM_WAIT": {
      "name": "ハンドオフ確認待ち",
      "description": "転送確認のYES/NO待ちフェーズ",
      "transitions": [
        {
          "condition": "intent == 'HANDOFF_YES' || HANDOFF_FALLBACK_YES",
          "target": "HANDOFF_DONE",
          "note": "転送実行"
        },
        {
          "condition": "intent == 'HANDOFF_NO' || HANDOFF_FALLBACK_NO",
          "target": "END"
        },
        {
          "condition": "あいまい応答 && retry == 0",
          "target": "HANDOFF_CONFIRM_WAIT",
          "note": "0604を再提示"
        },
        {
          "condition": "あいまい応答 && retry >= 1",
          "target": "END",
          "note": "安全側で終了"
        }
      ],
      "templates": ["0604", "081", "082", "086", "087"]
    },
    
    "HANDOFF_DONE": {
      "name": "ハンドオフ完了",
      "description": "転送実行済みフェーズ",
      "transitions": [
        {
          "condition": "転送完了",
          "target": null,
          "note": "PBX転送処理で通話が移るため、END遷移は省略"
        }
      ],
      "templates": ["081", "082"]
    },
    
    "END": {
      "name": "会話終了",
      "description": "会話終了フェーズ。自動切断タイマー（60秒）がセットされる",
      "transitions": [],
      "templates": ["086", "087", "088"]
    }
  },
  
  "handoff_flow": {
    "states": ["idle", "confirming", "done"],
    "transitions": {
      "idle -> confirming": [
        "HANDOFF_REQUEST",
        "UNKNOWN && handoff_prompt_sent == false",
        "not_heard_streak >= 2",
        "unclear_streak >= 2"
      ],
      "confirming -> done": [
        "HANDOFF_YES (明示的 or YESっぽいフレーズ)",
        "HANDOFF_NO (明示的 or NOっぽいフレーズ)",
        "あいまい応答(2回目以降) -> 安全側で終了"
      ],
      "confirming -> confirming": [
        "あいまい応答(最初の1回) -> 0604 を再度出す (handoff_retry_count=0 -> 1)"
      ],
      "done -> confirming": [
        "handoff_state=done だが再度 HANDOFF_REQUEST が来たとき 0604 再提示"
      ]
    },
    "confirmation_flow": {
      "explicit_yes": {
        "action": "転送実行",
        "templates": ["081", "082"],
        "transfer_requested": true
      },
      "explicit_no": {
        "action": "終了",
        "templates": ["086", "087"],
        "transfer_requested": false
      },
      "ambiguous_first": {
        "retry_count": 0,
        "action": "再確認",
        "templates": ["0604"],
        "transfer_requested": false
      },
      "ambiguous_retry": {
        "retry_count": ">= 1",
        "action": "安全側で終了",
        "templates": ["086", "087"],
        "transfer_requested": false,
        "note": "修正版：転送ではなく終了に変更"
      }
    }
  }
}

