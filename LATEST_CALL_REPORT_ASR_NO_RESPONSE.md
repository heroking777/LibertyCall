# 通話ログ分析レポート

**通話ID**: `in-2025122721375327`  
**通話日時**: 2025-12-27 21:37:53 ～ 22:13:06（約35秒）  
**分析日時**: 2025-12-27 22:15

---

## 📋 通話概要

### 観察された現象
- ✅ **初回アナウンス**: なし（ENTRYフェーズから直接QAフェーズに移行）
- ❌ **ASR反応**: あり（「もしもし。」を認識）→ しかし応答が再生されない
- ⚠️ **催促アナウンス**: 送信試行あり（template_id=110）→ 再生失敗
- ⏱️ **通話時間**: 約35秒

---

## 🔍 詳細分析

### 1. ASR動作状況

**✅ ASRは正常に動作しています**

```
21:38:48,688 [INFO] [ASR_TRANSCRIPT] on_transcript called: text='もし。' is_final=False
21:38:48,791 [INFO] [ASR_TRANSCRIPT] on_transcript called: text='もしもし。' is_final=False
21:38:49,967 [INFO] [ASR_TRANSCRIPT] on_transcript called: text='もしもし。' is_final=True
```

**認識結果**:
- 「もし。」→ 「もしもし。」→ 「もしもし。」（確定）
- GREETING検出: 成功
- dialogue_flow判定: 成功（template_id=004を選択）

---

### 2. 初回アナウンスの問題

**❌ 初回アナウンスが再生されていません**

```
21:38:48,694 [INFO] [FLOW_ENGINE] Phase transition: ENTRY -> QA
21:38:48,694 [INFO] FLOW_ENGINE: phase=ENTRY->QA intent=UNKNOWN templates=['114']
```

**問題点**:
- ENTRYフェーズから直接QAフェーズに移行
- 初回アナウンス（template_id=006など）が送信されていない
- ユーザーが「もしもし。」と言った時点で既にENTRYフェーズを通過

**想定される原因**:
- 通話開始時に初回アナウンスが送信されていない
- または、ENTRYフェーズの処理がスキップされている

---

### 3. 応答再生失敗（最重要問題）

**❌ すべての応答が再生に失敗しています**

#### 3.1 最初の応答（template_id=114）

```
21:38:48,694 [WARNING] [PLAYBACK] Skipping playback for stale session: 
  call_id=in-2025122721375327 
  (not in active calls: {'in-2025122721382807'})
```

**問題**: セッションがアクティブコールリストに存在しない

#### 3.2 挨拶応答（template_id=004）

```
21:38:48,793 [WARNING] [PLAYBACK] Skipping playback for stale session: 
  call_id=in-2025122721375327 
  (not in active calls: {'in-2025122721382807'})
```

**問題**: 同じくセッションがアクティブコールリストに存在しない

#### 3.3 催促アナウンス（template_id=110）

```
21:39:04,093 [WARNING] [PLAYBACK] Invalid session id detected: 
  uuid=c66b4c90-f77e-4ec4-a449-63ce9bd02b7a 
  reply=-ERR invalid session id [c66b4c90-f77e-4ec4-a449-63ce9bd02b7a]

21:39:04,096 [ERROR] [PLAYBACK] Fallback also failed: 
  call_id=in-2025122721375327 
  reply=-ERR invalid session id [in-2025122721375327]
```

**問題**: UUIDマッピングが失敗し、FreeSWITCHセッションが見つからない

---

### 4. UUIDマッピング問題

**UUIDの変遷**:
1. 初期UUID: `16995357-203e-4121-bf99-78a8636d0761` (21:37:53)
2. 更新UUID: `c66b4c90-f77e-4ec4-a449-63ce9bd02b7a` (21:39:04)
3. 最終UUID: `4e719712-4d02-457f-89b6-c5158d77c3f5` (22:12:36)

**問題点**:
- UUIDが複数回変更されている
- 各UUIDでFreeSWITCHセッションが見つからない（`-ERR invalid session id`）
- UUIDリマッピングも失敗

---

### 5. タイムアウトループ

**10秒ごとにタイムアウトが発生**:

```
22:12:32,124 [INFO] [ACTIVITY_MONITOR] Timeout detected: elapsed=36.0s
22:12:32,125 [INFO] Flow transition: QA -> NOT_HEARD
22:12:32,125 [INFO] [PLAY_TEMPLATE] Sent playback request: template_id=110
```

**問題**:
- タイムアウト検出 → NOT_HEARDフェーズ → template_id=110送信試行
- しかし再生に失敗 → 再度タイムアウト → ループ

---

## 🎯 根本原因の推測

### 主要問題: セッション管理の不整合

1. **アクティブコールリストの問題**
   - `call_id=in-2025122721375327` がアクティブコールリストに存在しない
   - 別の通話（`in-2025122721382807`）のみがリストに存在
   - これにより「stale session」として再生がスキップされる

2. **UUIDマッピングの失敗**
   - FreeSWITCHセッションUUIDが正しく取得できていない
   - または、セッションが既に終了している
   - UUIDリマッピング機能も機能していない

3. **初回アナウンスの欠如**
   - ENTRYフェーズで初回アナウンスが送信されていない
   - または、送信されたが再生に失敗している

---

## 📊 タイムライン

| 時刻 | イベント | 状態 |
|------|---------|------|
| 21:37:53 | 通話開始 | ✅ |
| 21:38:14 | ASR有効化 | ✅ |
| 21:38:31 | 音声パケット送信開始 | ✅ |
| 21:38:48 | 「もしもし。」認識 | ✅ |
| 21:38:48 | template_id=114送信試行 | ❌ 再生失敗（stale session） |
| 21:38:48 | template_id=004送信試行 | ❌ 再生失敗（stale session） |
| 21:39:04 | template_id=110送信試行 | ❌ 再生失敗（invalid session id） |
| 22:12:32 | タイムアウトループ開始 | ❌ |
| 22:13:06 | タイムアウトループ継続 | ❌ |

---

## 🔧 推奨される修正方針

### 優先度1: セッション管理の修正

1. **アクティブコールリストの同期**
   - 通話開始時に確実にアクティブコールリストに追加
   - 通話終了時に確実に削除
   - リストの整合性を保証

2. **UUIDマッピングの改善**
   - FreeSWITCHセッションUUIDの取得方法を確認
   - セッションが有効かどうかの検証を追加
   - セッション終了時の適切な処理

### 優先度2: 初回アナウンスの修正

1. **ENTRYフェーズの処理確認**
   - 初回アナウンスが確実に送信されるようにする
   - 再生成功を確認してから次のフェーズに移行

### 優先度3: エラーハンドリングの改善

1. **再生失敗時の処理**
   - 再生失敗を検出した場合の適切な処理
   - タイムアウトループの防止
   - エラーログの詳細化

---

## 📝 補足情報

### 認識された発話
- 「もし。」（部分認識）
- 「もしもし。」（確定認識、複数回）

### 選択されたテンプレート
- `114`: 「ご要件をもう一度お伺いしてもよろしいでしょうか？」（再生失敗）
- `004`: 「もしもし。」（再生失敗）
- `110`: 「もしもし？お声が遠いようです。もう一度お願いします。」（再生失敗）

### dialogue_flow判定
- ✅ 正常に動作（GREETING検出、適切なテンプレート選択）

---

## ✅ 結論

**ASRとdialogue_flowは正常に動作していますが、音声再生システムに重大な問題があります。**

1. ✅ ASR: 正常動作
2. ✅ dialogue_flow: 正常動作（Intent方式削除後も問題なし）
3. ❌ セッション管理: 重大な問題（アクティブコールリスト不整合）
4. ❌ 音声再生: 完全に失敗（UUIDマッピング失敗）

**修正が必要な箇所**:
- セッション管理（アクティブコールリスト）
- UUIDマッピング（FreeSWITCHセッション）
- 初回アナウンスの送信タイミング
