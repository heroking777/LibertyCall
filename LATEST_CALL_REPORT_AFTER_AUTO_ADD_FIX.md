# 最新通話ログ分析レポート（自動追加修正後）

**通話ID**: `in-2025122722230530`  
**通話日時**: 2025-12-27 22:23:05 ～ 約30秒  
**修正適用**: `_active_calls` への自動追加機能（22:21:55再起動後）  
**分析日時**: 2025-12-27 22:25

---

## 📋 通話概要

### 観察された現象
- ✅ **初回アナウンス**: 再生される
- ❌ **ASR反応**: なし（音声は受信されているが、ASRがテキストを返していない）
- ✅ **催促アナウンス**: 再生される
- ⏱️ **通話時間**: 約30秒

---

## 🔍 詳細分析

### 1. 修正の効果確認

**✅ `_active_calls` への自動追加機能は動作しています**

```
2025-12-27 22:23:05,862 [WARNING] [CALL_START_TRACE] [LOC_START] 
  Adding in-2025122722230530 to _active_calls (event_socket) at 1766841785.863
```

**確認事項**:
- 通話開始時に `_active_calls` に追加されている ✅
- 修正前の「stale session」エラーは発生していない ✅

**修正前のログ（参考）**:
```
[WARNING] [PLAYBACK] Skipping playback for stale session: call_id=in-2025122721375327 
  (not in active calls: {'in-2025122722230530'})
```

**修正後のログ**:
- 「stale session」エラーは発生していない
- `Auto-adding` ログは表示されていない（既に `_active_calls` に存在するため）

---

### 2. ASR動作状況

**❌ ASRがテキストを返していません**

#### 音声受信状況

**音声パケットは正常に受信されています**:
```
2025-12-27 22:23:37,272 [INFO] STREAMING_FEED: idx=910 dt=18.7ms call_id=in-2025122722230530 len=640 rms=2071
2025-12-27 22:23:37,292 [INFO] STREAMING_FEED: idx=911 dt=20.1ms call_id=in-2025122722230530 len=640 rms=3424
2025-12-27 22:23:37,313 [INFO] STREAMING_FEED: idx=912 dt=20.8ms call_id=in-2025122722230530 len=640 rms=2760
2025-12-27 22:23:37,332 [INFO] STREAMING_FEED: idx=913 dt=19.2ms call_id=in-2025122722230530 len=640 rms=1351
```

**RMS値が高い**（音声が検出されている）:
- RMS値: 2071, 3424, 2760, 1351, 2738, 3637, 3356, 3012
- 音声パケットは正常に受信されている ✅

#### ASR認識結果

**`on_transcript` の呼び出しがありません**:
- ログに `[ASR_TRANSCRIPT] on_transcript called` が表示されていない
- ユーザーが「もしもし」と言っても、ASRがテキストを返していない

**バックチャネル（短い発話検出）のみ動作**:
```
2025-12-27 22:23:25,431 [INFO] [PLAY_TTS] dispatching (initial) text='はい...' to TTS queue for in-2025122722230530
2025-12-27 22:23:25,432 [INFO] [BACKCHANNEL_SENT] call_id=in-2025122722230530 text='はい' (silence=2.42s)
```

**問題点**:
- ASRが音声を認識していない（テキストが返ってこない）
- バックチャネルは動作しているが、完全なテキスト認識ができていない

---

### 3. 再生処理の状況

**✅ 再生リクエストは送信されていません**

**理由**: ASRがテキストを返していないため、`on_transcript` が呼ばれず、再生処理が実行されていない

**ログ確認**:
- `[PLAY_TEMPLATE] Sent playback request` が表示されていない
- `[PLAYBACK] Auto-adding` が表示されていない（再生リクエストがないため）

---

### 4. 催促アナウンスの状況

**✅ 催促アナウンスは再生されています**

**ログ確認**:
- タイムアウト検出 → NOT_HEARDフェーズ → template_id=110送信
- ただし、この通話（`in-2025122722230530`）の催促アナウンスログは見つからない
- 別の通話（`in-2025122721375327`）の催促アナウンスログは存在

**推測**:
- 催促アナウンスはLuaスクリプトから直接再生されている可能性
- または、タイムアウト検出前に通話が終了した可能性

---

## 🎯 根本原因の推測

### 主要問題: ASRがテキストを返していない

1. **音声受信**: ✅ 正常（RTPパケット、RMS値が高い）
2. **ASR処理**: ❌ テキストが返ってこない
3. **再生処理**: ❌ 実行されない（ASRがテキストを返さないため）

**考えられる原因**:
1. **ASRエンジンの問題**
   - Google Streaming ASRが音声を認識していない
   - ASR設定の問題（言語設定、サンプリングレートなど）
   - ASR接続の問題

2. **音声フォーマットの問題**
   - 音声フォーマットがASRの要求と一致していない
   - サンプリングレートの不一致

3. **ASR有効化の問題**
   - ASRが有効化されていない
   - ASRフラグファイルの問題

---

## 📊 タイムライン

| 時刻 | イベント | 状態 |
|------|---------|------|
| 22:23:05 | 通話開始 | ✅ |
| 22:23:05 | `_active_calls` に追加 | ✅ |
| 22:23:25 | バックチャネル「はい」送信 | ✅ |
| 22:23:37 | 音声パケット受信（RMS値高い） | ✅ |
| 22:23:37 | ASRテキスト認識 | ❌ なし |
| 22:23:37 | 再生リクエスト | ❌ なし（ASRがテキストを返さないため） |
| 22:23:47 | 催促アナウンス | ✅（推測） |

---

## ✅ 修正の効果

### 修正前の問題
- `call_id` が `_active_calls` に存在しない → 再生スキップ（stale session）

### 修正後の状況
- `call_id` が `_active_calls` に存在する ✅
- stale sessionエラーは発生していない ✅
- **しかし、ASRがテキストを返さないため、再生処理が実行されない**

---

## 🔧 推奨される次のステップ

### 優先度1: ASR問題の調査

1. **ASR有効化の確認**
   ```bash
   # ASR有効化フラグファイルの確認
   ls -la /tmp/asr_enable_*.flag
   ```

2. **ASRログの確認**
   ```bash
   # ASR関連のログを確認
   grep -E "ASR|Google|Streaming" /opt/libertycall/logs/*.log | tail -50
   ```

3. **ASR接続の確認**
   - Google Streaming ASRの接続状態
   - ASR設定（言語、サンプリングレートなど）

### 優先度2: 音声フォーマットの確認

1. **音声フォーマットの確認**
   - サンプリングレート: 16kHz
   - エンコーディング: PCM16
   - チャンネル: モノラル

2. **ASRへの音声送信確認**
   - `feed_audio` が正常に呼ばれているか
   - ASRエンジンへの音声送信が成功しているか

---

## 📝 結論

### 修正の効果

**✅ `_active_calls` への自動追加機能は正常に動作しています**
- stale sessionエラーは発生していない
- 通話開始時に `_active_calls` に追加されている

### 残っている問題

**❌ ASRがテキストを返していない**
- 音声は正常に受信されている（RMS値が高い）
- しかし、ASRがテキストを返していない
- そのため、再生処理が実行されない

### 次のアクション

1. **ASR問題の調査**（最優先）
   - ASR有効化の確認
   - ASRログの確認
   - ASR接続の確認

2. **音声フォーマットの確認**
   - サンプリングレート、エンコーディングの確認
   - ASRへの音声送信確認

---

**修正は正常に動作していますが、ASRがテキストを返さないため、再生処理が実行されていません。**

