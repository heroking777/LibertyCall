# 最新通話ログ分析レポート（RTP_RAWログ追加後）

## 調査日時
2025-12-27 18:54頃

## 最新の通話ID
`in-2025122718530664`

---

## 【問題の概要】
- 実通話を行ったが、「もしもしｘ２反応なし」という問題が発生
- ユーザーが「もしもし」と2回発話したが、システムが反応しなかった
- **RTP_RAWログ、CALL_STATEログ、AI_COREログを追加した後の通話**

---

## 【ログ確認結果】

### 1. 通話開始時のログ
- **時刻**: 2025-12-27 18:53:06,976
- **ログ**: `[FS_RTP_MONITOR] Mapped call_id=in-2025122718530664 -> uuid=34603c73-2b57-476b-8657-46ff07f23d40`
- **ASR有効化**: 2025-12-27 18:53:27,996
  - `[FS_RTP_MONITOR] AICore.enable_asr() called successfully for uuid=34603c73-2b57-476b-8657-46ff07f23d40 call_id=in-2025122718530664 client_id=000`
- **ASR Generator開始**: 2025-12-27 18:53:28,155
  - `[REQUEST_GEN] Generator started for call_id=in-2025122718530664`

### 2. RTP_RAWログ（追加したログ）の分析

#### 2.1. 通話終了後のRTPパケット
- **最初のRTP_RAWログ**: 2025-12-27 18:54:00,862
  - `Time=1766829240.862 Len=172 PT=0 SSRC=554b5a11 Seq=32435 Mark=0 Addr=('61.213.230.72', 11892)`
- **最初のRTP_SKIPログ**: 2025-12-27 18:53:35,043
  - `Time=1766829215.043 call_id=in-2025122718530664 already ended (Active=False)`
- **時間差**: 25.819秒
  - **RTP_SKIPが先（18:53:35,043）→ RTP_RAWが後（18:54:00,862）**

#### 2.2. RTPパケットの詳細
- **Payload Type (PT)**: 0（PCMU - μ-law）→ 正しい
- **SSRC**: 2つの異なるSSRCが確認できる
  - `554b5a11`: ユーザー側（61.213.230.72, 11892）
  - `8d73e063`: システム側（160.251.170.253, 7102）
- **双方向通信**: RTPパケットは双方向で受信されている

#### 2.3. 重要な発見
- **通話中にRTP_RAWログが出力されていない**
  - 通話開始（18:53:06,976）から通話終了（18:53:35,043より前）までの間にRTP_RAWログが見つからない
  - 通話終了後（18:54:00,862）にRTP_RAWログが出力されている

### 3. RTP_SKIPログ（通話終了後のパケット）
- **確認結果**: RTP_SKIPログが出力されている
- **最初のRTP_SKIP**: 2025-12-27 18:53:35,043
  - `Time=1766829215.043 call_id=in-2025122718530664 already ended (Active=False). Skipping handle_rtp_packet`
- **重要な発見**:
  - **18:53:35,043**: 既に通話が終了している
  - **通話終了後もRTPパケットが受信されている**

### 4. CALL_STATEログ（通話終了時刻）
- **確認結果**: CALL_STATEログが見つからない
- **理由**: 通話終了処理が別の経路で行われている可能性
- **推測**: 通話終了は18:53:35,043より前

### 5. AI_COREログ（on_new_audio呼び出し）
- **確認結果**: AI_COREログが見つからない
- **判定**: `on_new_audio`が呼ばれていない
- **理由**: 
  - 通話中にRTPパケットが受信されていない
  - または、RTPパケットが通話終了後に受信されているため、処理がスキップされている

### 6. RTP_PAYLOAD_DEBUGログ
- **確認結果**: RTP_PAYLOAD_DEBUGログが出力されている
- **ログ例**:
  ```
  2025-12-27 18:53:35,043 [INFO] [RTP_PAYLOAD_DEBUG] call_id=in-2025122718530664 payload_len=160 first_bytes=ffffffffffffffffffff
  2025-12-27 18:53:35,062 [INFO] [RTP_PAYLOAD_DEBUG] call_id=in-2025122718530664 payload_len=160 first_bytes=feffff7efffffeffffff
  ```
- **重要な発見**:
  - **first_bytes**: すべて0xFFが多く含まれている
  - **判定**: 無音データ
  - **時刻**: 18:53:35,043（通話終了後）

### 7. ASR結果
- **確認結果**: ASR_TRANSCRIPTログが見つからない
- **判定**: Google ASRが音声を認識していない

---

## 【現在のアクティブな通話本数】

### 確認方法
最新のログから `Added call_id` と `Removed call_id` を確認

### 結果
- **最新のログ**: 18:54:02時点で `in-2025122718530664` は既に終了している
- **アクティブな通話**: 現在のアクティブな通話本数は **0本** と推測されます

---

## 【重要な発見】

### 1. 通話中にRTPパケットが受信されていない
- **通話開始**: 18:53:06,976
- **ASR有効化**: 18:53:27,996（約21秒後）
- **通話終了**: 18:53:35,043より前（約28秒以内）
- **RTP_RAWログ**: 通話中には出力されていない
- **RTP_RAWログ（通話終了後）**: 18:54:00,862から出力されている

### 2. 通話終了が早すぎる
- 通話開始から約28秒以内に終了している
- CALL_STATEログが見つからないため、通話終了処理が別の経路で行われている可能性

### 3. RTPパケットが通話終了後に受信されている
- **RTP_SKIP最初**: 18:53:35,043（Time=1766829215.043）
- **RTP_RAW最初**: 18:54:00,862（Time=1766829240.862）
- **時間差**: 25.819秒
- **判定**: 通話終了後（18:53:35,043より前）にRTPパケットが受信されている

### 4. on_new_audioが呼ばれていない
- **AI_COREログ**: 見つからない
- **理由**: 
  - 通話中にRTPパケットが受信されていない
  - または、RTPパケットが通話終了後に受信されているため、処理がスキップされている

### 5. RTPパケットの内容が無音
- **RTP_PAYLOAD_DEBUG**: すべて0xFFが多く含まれている
- **判定**: 無音データ
- **時刻**: 通話終了後

---

## 【問題の分析】

### 1. 通話中にRTPパケットが受信されていない
- **通話開始**: 18:53:06,976
- **通話終了**: 18:53:35,043より前
- **RTP_RAWログ**: 通話中には出力されていない
- **判定**: 通話中にRTPパケットが正しく受信されていない可能性

### 2. 通話終了判定が早すぎる
- 通話開始から約28秒以内に終了している
- CALL_STATEログが見つからないため、通話終了処理が別の経路で行われている可能性

### 3. RTPパケットが通話終了後に受信されている
- 通話終了後（18:53:35,043より前）にRTPパケットが受信されている
- これは、ネットワーク遅延やバッファの問題の可能性

### 4. 音声データがASRに送信されていない
- AI_COREログが見つからない
- on_new_audioが呼ばれていない
- 理由: 通話中にRTPパケットが受信されていないため

---

## 【次のステップ】

1. **通話中にRTPパケットが受信されていない原因の特定**
   - FreeSWITCHからRTPパケットが送信されていたか確認
   - pcapキャプチャが正しく動作していたか確認

2. **通話終了時刻の特定**
   - CALL_STATEログが見つからない原因を特定
   - 通話終了処理がどこで行われているか確認

3. **RTPパケット受信タイミングの確認**
   - 通話中にRTPパケットが受信されていたか確認
   - pcapキャプチャのタイミングを確認

---

## 【補足情報】

- **ログファイルサイズ**: 約116MB
- **最新のログ時刻**: 2025-12-27 18:54:02
- **調査対象通話ID**: `in-2025122718530664`
- **通話開始時刻**: 2025-12-27 18:53:06,976
- **ASR有効化時刻**: 2025-12-27 18:53:27,996
- **通話終了時刻**: 2025-12-27 18:53:35,043より前（推測）
- **通話継続時間**: 約28秒以内
- **RTP_SKIP最初**: 18:53:35,043（Time=1766829215.043）
- **RTP_RAW最初**: 18:54:00,862（Time=1766829240.862）
- **時間差**: 25.819秒

---

報告完了
