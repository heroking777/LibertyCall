# LibertyCall 新設計思想: 対話フロー方式

**作成日**: 2025-12-27  
**目的**: Intent判定の複雑さを排除し、自然な会話フローで誤案内ゼロを実現

---

## 設計の背景

### 従来の問題点（Intent方式）

1. **複雑な判定ロジック**
   - "料金はいくらですか？" が INQUIRY になる
   - 優先順位が不明確
   - キーワードが複数箇所に散らばる

2. **誤案内のリスク**
   - AIが勝手に「たぶん月額のことだろう」と決めつける
   - ユーザーが本当に聞きたいことと違う回答をする

3. **保守の困難さ**
   - classify_intent() と select_template_ids() の2段階
   - Intentを追加するたびに複数箇所を修正

### 新しい設計思想

**「曖昧な質問には聞き返す。明確な質問には即答する。」**

---

## 基本原則

### 原則1: 曖昧さを許容しない

```
ユーザー: "料金教えて"（曖昧）
AI: "どの料金でしょうか？初期費用、通話料、月額のどれですか？"
ユーザー: "月額"
AI: "月額20万円、税別です"
```

### 原則2: 明確な質問には即答

```
ユーザー: "月額料金教えて"（明確）
AI: "月額20万円、税別です"
```

### 原則3: 割り込み対応を最大限活用

```
AI: "どの料金でしょうか？初期費用、通話料、月—"
ユーザー: "月額！"（割り込み）
AI: "（0.3秒以内に反応）月額20万円、税別です"
```

**発話割込対応があるから、聞き返しても時間の無駄にならない**

---

## 設計のメリット

### 1. 誤案内ゼロ
- AIが勝手に決めつけない
- ユーザーに確認してから回答

### 2. Intent判定が不要
- 複雑な優先順位の管理が不要
- キーワードの衝突が起きない

### 3. 保守が簡単
- 聞き返しパターンを追加するだけ
- 1箇所の修正で完結

### 4. 自然な会話
- 人間同士の会話と同じ
- ユーザーがストレスを感じない

### 5. 拡張性が高い
- 新しい聞き返しパターンを簡単に追加できる
- 既存の処理に影響しない

---

## 実装方式の比較

### 従来方式（Intent方式）

```
質問 → Intent判定 → テンプレート選択 → 応答
       ↑ 複雑       ↑ 2段階
```

**問題点:**
- Intent判定が複雑で誤判定が起きる
- 2段階なので保守が大変

### 新方式（対話フロー方式）

```
質問 → 曖昧？ → Yes → 聞き返し → ユーザー回答待ち → 応答
              ↓ No
              即答
```

**メリット:**
- シンプル
- 誤判定がない（ユーザーに確認する）
- 1段階で完結

---

## 聞き返しパターンの設計

### パターン1: 料金

#### 曖昧な質問
- "料金教えて"
- "いくらですか？"
- "値段は？"

#### 聞き返しテンプレート
**テンプレートID**: 115  
**内容**: "どの料金でしょうか？初期費用、（0.5秒）通話料、（0.5秒）月額のどれですか？"

#### Phase遷移
- 聞き返し後: `WAITING_PRICE_TYPE`
- ユーザー回答後: `QA` に戻る

#### ユーザー回答に対する応答

| ユーザー回答 | テンプレートID | 内容 |
|------------|--------------|------|
| "初期費用" | 042 | "初期費用は一切かかりません。" |
| "通話料" | 116（新規） | "通話料は1分あたり3円です。" |
| "月額" | 040 | "料金は月額二十万円、税別となります。" |

---

### パターン2: 機能

#### 曖昧な質問
- "機能教えて"
- "何ができますか？"
- "どんな機能？"

#### 聞き返しテンプレート
**テンプレートID**: 117（新規）  
**内容**: "どの機能について詳しく知りたいですか？発話割込、（0.5秒）営業電話対応、（0.5秒）転送機能、（0.5秒）その他の機能？"

#### Phase遷移
- 聞き返し後: `WAITING_FUNCTION_TYPE`
- ユーザー回答後: `QA` に戻る

#### ユーザー回答に対する応答

| ユーザー回答 | テンプレートID | 内容 |
|------------|--------------|------|
| "割込" / "途中で話す" | 065 | "リアルタイムで発話割り込みに対応いたします。" |
| "営業電話" | 118（新規） | "AIが営業電話を自動判定し、丁重にお断りします。" |
| "転送" | 023 | "AIが電話応対し、必要に応じて担当者へ引き継ぎます。" |
| "その他" / "全部" | 119（新規） | "24時間365日対応、方言対応、詳細な対応履歴など、様々な機能がございます。詳しくはどの機能が気になりますか？" |

---

### パターン3: 導入

#### 曖昧な質問
- "導入について"
- "始めるには？"

#### 聞き返しテンプレート
**テンプレートID**: 120（新規）  
**内容**: "導入について何が気になりますか？導入期間、（0.5秒）設定の難易度、（0.5秒）サポート体制？"

#### Phase遷移
- 聞き返し後: `WAITING_SETUP_TYPE`
- ユーザー回答後: `QA` に戻る

#### ユーザー回答に対する応答

| ユーザー回答 | テンプレートID | 内容 |
|------------|--------------|------|
| "期間" / "いつから" | 060 | "最短即日から導入が可能です。" |
| "設定" / "難しい" | 0603 | "初期設定はこちらで代行いたしますので、お店側の作業はほとんどございません。" |
| "サポート" | 0284 | "導入後もチャット・電話でのサポートが可能です。" |

---

## 明確な質問（即答パターン）

### 料金関連（明確）

| 質問例 | 検出キーワード | テンプレートID |
|--------|--------------|--------------|
| "月額いくらですか？" | "月額" + ("料金" or "いくら" or "値段") | 040 |
| "初期費用はかかりますか？" | "初期費用" or "初期コスト" | 042 |
| "通話料は？" | "通話料" | 116（新規） |
| "最低契約期間は？" | "最低契約" or "契約期間" | 045 |
| "解約料は？" | "解約" | 046 |

### 機能関連（明確）

| 質問例 | 検出キーワード | テンプレートID |
|--------|--------------|--------------|
| "途中で話しても大丈夫？" | "途中で話" or "割り込" or "口挟" | 065 |
| "関西弁に対応してる？" | "関西弁" or "方言" | 066 |
| "24時間対応？" | "24時間" or "夜間" or "休日" | 121（新規） |
| "担当者に転送できる？" | "転送" or "引継" | 023 |
| "セキュリティは？" | "セキュリティ" or "個人情報" or "録音" | 063 |

### 導入関連（明確）

| 質問例 | 検出キーワード | テンプレートID |
|--------|--------------|--------------|
| "いつから使えますか？" | "いつから" or "すぐ" | 060 |
| "設定は難しい？" | "設定" + ("難しい" or "簡単") | 0603 |

---

## Phase管理

### 新しいPhase定義

| Phase | 意味 | 遷移条件 |
|-------|------|---------|
| `QA` | 通常の質疑応答 | デフォルト |
| `WAITING_PRICE_TYPE` | 料金の種類を待っている | 料金の聞き返し後 |
| `WAITING_FUNCTION_TYPE` | 機能の種類を待っている | 機能の聞き返し後 |
| `WAITING_SETUP_TYPE` | 導入の種類を待っている | 導入の聞き返し後 |
| `HANDOFF_CONFIRM_WAIT` | ハンドオフ確認待ち | 既存 |
| `END` | 通話終了 | 既存 |

### Phase遷移ルール

```
QA → (曖昧な料金質問) → WAITING_PRICE_TYPE
WAITING_PRICE_TYPE → (ユーザー回答) → QA

QA → (曖昧な機能質問) → WAITING_FUNCTION_TYPE
WAITING_FUNCTION_TYPE → (ユーザー回答) → QA

QA → (曖昧な導入質問) → WAITING_SETUP_TYPE
WAITING_SETUP_TYPE → (ユーザー回答) → QA
```

---

## 応答判定ロジック

### ロジックの流れ

```python
def get_response(user_text: str, current_phase: str) -> tuple[list[str], str]:
    """
    ユーザーの発話から応答テンプレートとPhaseを返す
    
    Returns:
        (template_ids, new_phase)
    """
    
    # ステップ1: Phase別の処理
    if current_phase == "WAITING_PRICE_TYPE":
        return handle_price_type_response(user_text)
    
    if current_phase == "WAITING_FUNCTION_TYPE":
        return handle_function_type_response(user_text)
    
    if current_phase == "WAITING_SETUP_TYPE":
        return handle_setup_type_response(user_text)
    
    # ステップ2: 明確な質問の判定（即答）
    response = check_clear_questions(user_text)
    if response:
        return (response, "QA")
    
    # ステップ3: 曖昧な質問の判定（聞き返し）
    if is_ambiguous_price_question(user_text):
        return (["115"], "WAITING_PRICE_TYPE")
    
    if is_ambiguous_function_question(user_text):
        return (["117"], "WAITING_FUNCTION_TYPE")
    
    if is_ambiguous_setup_question(user_text):
        return (["120"], "WAITING_SETUP_TYPE")
    
    # ステップ4: その他の処理（GREETING, HANDOFF_REQUEST, etc）
    # ...
    
    # ステップ5: どれにも該当しない場合
    return (["114"], "QA")  # "ご要件をもう一度..."
```

---

## 新規テンプレートリスト

### 追加が必要なテンプレート

| ID | 内容 | 用途 |
|----|------|------|
| 115 | "どの料金でしょうか？初期費用、通話料、月額のどれですか？" | 料金の聞き返し |
| 116 | "通話料は1分あたり3円です。" | 通話料の説明 |
| 117 | "どの機能について詳しく知りたいですか？発話割込、営業電話対応、転送機能、その他の機能？" | 機能の聞き返し |
| 118 | "AIが営業電話を自動判定し、丁重にお断りします。精度は98%以上です。" | 営業電話対応の説明 |
| 119 | "24時間365日対応、方言対応、詳細な対応履歴など、様々な機能がございます。詳しくはどの機能が気になりますか？" | 機能の全体説明 |
| 120 | "導入について何が気になりますか？導入期間、設定の難易度、サポート体制？" | 導入の聞き返し |
| 121 | "24時間365日、休日・夜間も対応いたします。" | 24時間対応の説明 |

---

## 実装の優先順位

### フェーズ1: 料金の聞き返し実装（最優先）
- 理由: LPを見た人が最も多く聞く質問
- 範囲:
  - 料金の聞き返し（テンプレート115）
  - 通話料の説明（テンプレート116）
  - Phase: WAITING_PRICE_TYPE

### フェーズ2: 機能の聞き返し実装
- 理由: 2番目に多い質問
- 範囲:
  - 機能の聞き返し（テンプレート117-119）
  - Phase: WAITING_FUNCTION_TYPE

### フェーズ3: 導入の聞き返し実装
- 理由: 3番目に多い質問
- 範囲:
  - 導入の聞き返し（テンプレート120-121）
  - Phase: WAITING_SETUP_TYPE

### フェーズ4: 他の聞き返しパターン追加
- 予約、サポート、その他

---

## 移行計画

### ステップ1: 新しい応答判定ロジックを作成
- `libertycall/gateway/dialogue_flow.py` を新規作成
- Intent方式とは独立して実装

### ステップ2: テンプレート追加
- `default_flow.json` に新規テンプレート（115-121）を追加

### ステップ3: Phase定義追加
- `flow.json` に新Phase定義を追加

### ステップ4: ai_core.py の修正
- `dialogue_flow.py` を使うように変更
- Intent方式は残す（フォールバック用）

### ステップ5: テスト
- 料金の聞き返しパターンをテスト
- 問題なければ、機能・導入も追加

### ステップ6: Intent方式の段階的廃止
- 新方式で問題なければ、Intent方式を削除

---

## 成功の指標

### 定量指標
1. **誤案内率**: 0%目標
2. **聞き返し後の正答率**: 95%以上
3. **平均応答時間**: 5秒以内（割り込みあり）
4. **ユーザー満足度**: 4.5/5以上

### 定性指標
1. 「自然な会話だった」と感じるユーザーの割合
2. 「答えが的確だった」と感じるユーザーの割合
3. 「ストレスを感じなかった」と感じるユーザーの割合

---

## まとめ

### この設計の核心

**「AIが勝手に決めつけない。曖昧なら聞き返す。割り込みで即答できる。」**

### 従来との違い

| 項目 | 従来（Intent方式） | 新方式（対話フロー） |
|------|------------------|-------------------|
| 曖昧な質問 | AIが勝手に判断 | 聞き返す |
| 誤案内リスク | あり | ゼロ |
| 保守性 | 複雑 | シンプル |
| 会話の自然さ | 機械的 | 人間的 |
| 実装の複雑さ | 高い | 低い |

### この設計が成功する理由

1. **LPの「発話割込対応」を最大限活用**
2. **人間同士の会話を再現**
3. **ユーザーに選択肢を与える**
4. **エンジニアにとっても保守しやすい**

---

**この設計思想に基づいて、次のステップに進みます。**

