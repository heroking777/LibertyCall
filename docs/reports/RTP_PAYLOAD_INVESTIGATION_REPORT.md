# RTP_PAYLOAD_DEBUG調査レポート

## 調査実施日時
2025-12-27 18:30頃

## 調査内容

### 手順1: 通話開始直後のログ取得

**最新の通話ID:**
- `in-2025122718283823`

**`on_call_start` の時刻:**
- 2025-12-27 18:28:38,699

**ログ確認結果:**
```
2025-12-27 18:28:38,699 [INFO] [EVENT_SOCKET] Generated call_id=in-2025122718283823 from uuid=f78cd2a4-3945-4ae5-bcae-3627cf11327c client_id=000
2025-12-27 18:28:38,699 [INFO] [AICORE] on_call_start() call_id=in-2025122718283823 client_id=000
```

---

### 手順2: RTP_PAYLOAD_DEBUGログの確認

**[RTP_PAYLOAD_DEBUG] の出力: なし（最新の通話では見つからない）**

**補足:**
- 別の通話（`in-2025122718282569`）では`RTP_PAYLOAD_DEBUG`ログが見つかりました
- ログ例:
  ```
  2025-12-27 18:28:28,035 [INFO] [RTP_PAYLOAD_DEBUG] call_id=in-2025122718282569 payload_len=160 first_bytes=e6c9bfbcbbc2c9c7c4bc
  2025-12-27 18:28:28,084 [INFO] [RTP_PAYLOAD_DEBUG] call_id=in-2025122718282569 payload_len=160 first_bytes=c0bfbebec7cac4c3bebf
  2025-12-27 18:28:28,106 [INFO] [RTP_PAYLOAD_DEBUG] call_id=in-2025122718282569 payload_len=160 first_bytes=f4ebe8edeaf1f1e2e7e9
  ```

**判定:**
- `first_bytes`は0x00や0xFFではなく、正常なバラツキがある
- これは正常なμ-lawデータであることを示している

**最新の通話（`in-2025122718283823`）で見つからない理由:**
- `RTP_PAYLOAD_DEBUG`は最初の5回のみ出力される設定
- 通話開始直後（18:28:38）に既に出力済みの可能性
- または、`effective_call_id`が取得できなかった可能性

---

### 手順3: FreeSWITCHのエコーキャンセル設定確認

**switch.conf.xml:**
- `ec_taps`や`echo_cancel`の設定: **見つからない**
- エコーキャンセル関連の設定は見当たらない

**external.xml:**
- `ec_taps`や`echo_cancel`の設定: **見つからない**
- エコーキャンセル関連の設定は見当たらない

**補足:**
- FreeSWITCHの設定ファイルには、エコーキャンセル関連の設定が見つかりませんでした
- これは、エコーキャンセルが無効になっているか、デフォルト設定を使用している可能性があります

---

## 重要な発見

### RMS値の時系列変化

**通話開始直後（18:28:38）:**
- RMS値: **3000-5000程度**（正常な音声レベル）
- ログ例:
  ```
  2025-12-27 18:28:38,716 [INFO] STREAMING_FEED: idx=443 rms=3242
  2025-12-27 18:28:38,803 [INFO] [RTP_AUDIO_RMS] stage=ulaw_decode rms=3543
  2025-12-27 18:28:38,974 [INFO] [RTP_AUDIO_RMS] stage=ulaw_decode rms=4832
  ```

**通話中（18:29:01以降）:**
- RMS値: **1-72程度**（異常に低い）
- ログ例:
  ```
  2025-12-27 18:29:01,934 [INFO] [RTP_AUDIO_RMS] stage=ulaw_decode rms=13
  2025-12-27 18:29:02,733 [INFO] [RTP_AUDIO_RMS] stage=ulaw_decode rms=4
  2025-12-27 18:29:05,532 [INFO] [RTP_AUDIO_RMS] stage=ulaw_decode rms=0
  ```

**分析:**
- 通話開始直後は正常な音声レベル（RMS=3000-5000）
- その後、RMS値が急激に低下（RMS=1-72）
- これは、TTS再生音が終了した後、ユーザーの音声が非常に小さいか、無音になっている可能性

---

## 結論

### 問題の特定

1. **RTPパケットの音声データは正常**
   - 別の通話の`RTP_PAYLOAD_DEBUG`ログから、μ-lawデータは正常であることが確認できた
   - `first_bytes`は正常なバラツキがある

2. **通話開始直後は正常な音声レベル**
   - RMS値が3000-5000程度（正常）
   - これはTTS再生音などが受信されていた可能性

3. **その後、RMS値が急激に低下**
   - RMS値が1-72程度に低下
   - これは、ユーザーの音声が非常に小さいか、無音になっている可能性

### 考えられる原因

1. **ユーザーの音声が非常に小さい**
   - マイクの音量設定が低い
   - 電話機の音量設定が低い
   - 距離が遠い、または環境音が大きい

2. **FreeSWITCHのエコーキャンセルが影響している可能性**
   - エコーキャンセル設定が見つからないが、デフォルト設定が有効になっている可能性
   - エコーキャンセルが音声を抑制している可能性

3. **RTPルーティングの問題**
   - ユーザーの音声が正しくルーティングされていない可能性
   - 双方向通信の問題

---

## 推奨される対処方法

1. **RTP_PAYLOAD_DEBUGログを常時出力するように変更**
   - 最初の5回のみではなく、定期的に出力する
   - または、RMS値が低い場合に出力する

2. **FreeSWITCHのエコーキャンセル設定を確認**
   - エコーキャンセルを明示的に無効化する
   - または、エコーキャンセルのパラメータを調整する

3. **実際の音声データをWAVファイルに保存**
   - 受信した音声データをWAVファイルに保存して確認
   - 実際に音声が含まれているか確認

---

## 補足情報

- **RTP_PAYLOAD_DEBUG**: 別の通話では正常なデータが確認できた
- **RMS値の変化**: 通話開始直後は正常、その後急激に低下
- **FreeSWITCH設定**: エコーキャンセル関連の設定が見つからない

