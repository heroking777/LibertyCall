# ASR空文字列問題 - 実通話テスト結果レポート

## テスト実施日時
2025-12-27 18:17頃（通話ID: `in-2025122718171268`）

## テスト内容
- 実通話を実施
- 「もしもし」を2回発話
- 反応なし

---

## 診断結果サマリー

### ✅ 正常に動作している項目

1. **通話開始処理**
   - `on_call_start()` が正常に呼ばれている
   - 通話ID: `in-2025122718171268`
   - クライアントID: `000`

2. **ASRストリーム起動**
   - `STREAM_WORKER_START` が正常に動作
   - `REQUEST_GEN` が正常に動作（音声データをGoogle ASRに送信）

3. **音声データ送信**
   - `QUEUE_PUT` が正常に動作（640バイトのチャンクを送信）
   - `on_new_audio` が正常に呼ばれている
   - 音声データはGoogle ASRに送信されている

4. **RMS値のログ出力**
   - 新しく追加したRMS値ログが正常に出力されている

---

## ⚠️ 問題が発見された項目

### 1. RMS値が異常に低い（最重要の問題）

**発見されたRMS値:**
- 大部分: `rms=1` ～ `rms=9`
- 最大値: `rms=9`
- 正常な音声の場合: `rms=100以上` が期待される

**ログ例:**
```
2025-12-27 18:17:43,143 [INFO] GoogleASR: [STREAMING_FEED] call_id=in-2025122718171268 len=640 bytes rms=1
2025-12-27 18:17:43,163 [INFO] GoogleASR: [STREAMING_FEED] call_id=in-2025122718171268 len=640 bytes rms=1
2025-12-27 18:17:43,183 [INFO] GoogleASR: [STREAMING_FEED] call_id=in-2025122718171268 len=640 bytes rms=2
2025-12-27 18:17:43,203 [INFO] GoogleASR: [STREAMING_FEED] call_id=in-2025122718171268 len=640 bytes rms=2
```

**診断:**
- **RMS値が1-9しかない = ほぼ無音データ**
- 正常な音声ならRMS値は100以上になるはず
- **音声データが正しく受信されていない可能性が高い**

---

### 2. ASR結果が空文字列または認識されていない

**確認結果:**
- `ASR_GOOGLE_RAW` のログが見つからない
- `ASR_TRANSCRIPT` のログが見つからない
- `ASR_RESULT` のログが見つからない

**ただし、`gateway_stdout.log`には以下のログが見つかりました:**
```
🗣️ [発信者: 未設定] [2025-12-27T18:17:16.942435] CALLER=未設定 PHASE=ENTRY TEMPLATE=NONE TEXT=はい
🗣️ [発信者: 未設定] [2025-12-27T18:17:37.142651] CALLER=未設定 PHASE=ENTRY TEMPLATE=NONE TEXT=はい
🗣️ [発信者: 未設定] [2025-12-27T18:17:41.322535] CALLER=未設定 PHASE=ENTRY TEMPLATE=NONE TEXT=はい
🗣️ [発信者: 未設定] [2025-12-27T18:17:43.423009] CALLER=未設定 PHASE=ENTRY TEMPLATE=NONE TEXT=はい
```

**診断:**
- ASRは「はい」と認識しているが、RMS値が1-9なので誤認識の可能性が高い
- 実際の発話「もしもし」が認識されていない
- RMS値が低すぎるため、Google ASRが正しく音声を認識できない

---

## 根本原因の推測

### 原因1: 音声データが無音（最も可能性が高い）

**証拠:**
- RMS値が1-9しかない（正常なら100以上）
- 音声データは送信されているが、内容が無音

**考えられる原因:**
1. **RTPパケットから音声データが正しく抽出されていない**
   - μ-lawデコードの問題
   - パケットのペイロード抽出の問題

2. **FreeSWITCHからの音声ルーティングの問題**
   - 音声が正しく送信されていない
   - ルーティング設定の問題

3. **音声データの変換処理の問題**
   - 8kHz → 16kHz変換の問題
   - PCM形式の変換の問題

---

## 現在のアクティブな通話本数

**確認方法:**
- `_active_calls` セットで管理されている
- コード上は `self.gateway._active_calls` で確認可能

**最新の通話:**
- 通話ID: `in-2025122718171268`
- ステータス: **終了済み**（`on_call_end` が呼ばれている）
- 終了時刻: 2025-12-27 18:17:43

**ログ確認結果:**
```
2025-12-27 18:17:43,652 [INFO] [EVENT_SOCKET] Received event: call_end uuid=0d2ff42c-bd10-447c-8d6e-cebd576489d2
2025-12-27 18:17:43,652 [INFO] [AICORE] on_call_end() call_id=in-2025122718171268
2025-12-27 18:17:43,659 [INFO] [EVENT_SOCKET] Removed call_id=in-2025122718171268 from _active_calls
```

**現在のアクティブな通話本数:**
- **0件**（最新の通話は終了済み）
- `_active_calls` から `in-2025122718171268` が削除されている

---

## 推奨される対処方法

### 1. RTPパケットの音声データ抽出を確認（最優先）

**確認ポイント:**
- RTPパケットから音声データ（μ-law）が正しく抽出されているか
- μ-law → PCM16変換が正しく行われているか
- 8kHz → 16kHz変換が正しく行われているか

**確認場所:**
- `realtime_gateway.py` の `handle_rtp_packet` メソッド
- 音声データの変換処理

### 2. 音声データの内容を確認

**デバッグ方法:**
- 受信した音声データをWAVファイルに保存
- 実際に音声が含まれているか確認
- RMS値の計算が正しいか確認

### 3. FreeSWITCHの音声ルーティングを確認

**確認ポイント:**
- FreeSWITCHが正しく音声を送信しているか
- RTPポートが正しく設定されているか
- 音声コーデックの設定

---

## 次のステップ

1. **RTPパケットの音声データ抽出処理を確認**
   - `handle_rtp_packet` メソッドの音声データ抽出部分
   - μ-lawデコード処理

2. **音声データのデバッグログを追加**
   - 受信した音声データのサンプル値をログ出力
   - WAVファイルに保存して確認

3. **FreeSWITCHの音声ルーティングを確認**
   - RTPポートの設定
   - 音声コーデックの設定

---

## 補足情報

- **RMS値のログ出力**: 正常に動作している
- **ASRストリーム**: 正常に起動している
- **音声データ送信**: 正常に送信されている
- **問題**: 音声データの内容が無音（RMS値が1-9）

**結論:**
- ASRの設定やストリームは正常
- **問題は音声データが無音であること**
- RTPパケットからの音声データ抽出または変換処理に問題がある可能性が高い

