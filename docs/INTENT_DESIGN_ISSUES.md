# Intent設計の問題点

**分析対象**: `libertycall/libertycall/gateway/intent_rules.py` の `select_template_ids()` 関数  
**分析日時**: 2025-12-27

---

## 問題カテゴリA: 複数テンプレートを返す (会話が冗長)

| Intent | 返すテンプレート数 | 内容 | 問題の深刻度 |
|--------|------------------|------|------------|
| SYSTEM_EXPLAIN | 4つ | ["020", "023", "021", "085"] | **高** - 長すぎる応答 |
| END_CALL | 3つ | ["086", "087", "088"] | **高** - 終了時に3つは冗長 |
| PRICE | 最大3つ | ["049", "048", "047"] (条件分岐) | 中 - 条件によっては3つ |
| INQUIRY | 最大3つ | ["0280", "0281", "0283"] (条件分岐) | 中 - 条件によっては3つ |
| FUNCTION | 最大3つ | ["0280", "0281", "0283"] (条件分岐) | 中 - 条件によっては3つ |
| RESERVATION | 常に2つ | ["070", "085"] / ["071", "085"] / ["072", "085"] | 中 - 常に2つ固定 |
| MULTI_STORE | 2つ | ["069", "085"] | 中 |
| DIALECT | 2つ | ["066", "085"] | 中 |
| INTERRUPT | 2つ | ["065", "085"] | 中 |
| BUSY | 2つ | ["090", "098"] | 中 |
| SALES_CALL | 2つ | ["094", "088"] (条件分岐) | 中 |
| INQUIRY | 2つ | ["006", "010"] (条件分岐) | 中 |

### 詳細分析

#### SYSTEM_EXPLAIN (深刻度: 高)
- **現状**: 4つのテンプレートを連続再生
- **問題**: システム説明が長すぎてユーザーが飽きる可能性
- **推奨**: 1つのテンプレートに統一（例: "020" のみ）

#### END_CALL (深刻度: 高)
- **現状**: ["086", "087", "088"] = 「お電話ありがとうございました。また何かあればいつでもご相談くださいね。失礼いたします。」
- **問題**: 終了時に3つは冗長、ユーザーが切る前に長すぎる
- **推奨**: 1つのテンプレートに統一（例: "086" のみ）

#### PRICE (深刻度: 中)
- **現状**: 条件によって最大3つ ["049", "048", "047"]
- **問題**: 条件分岐が複雑で、3つは長い
- **推奨**: 1つのテンプレートに統一（例: "040" のみ）

---

## 問題カテゴリB: 空リストを返す (ai_core側で処理が必要)

| Intent | 空リスト理由 | ai_core側の処理 | 問題の深刻度 |
|--------|------------|----------------|------------|
| HANDOFF_YES | ai_core側で処理 | 081+082を返す | **高** - 一貫性なし |
| HANDOFF_NO | ai_core側で処理 | 086+087を返す | **高** - 一貫性なし |
| HANDOFF_REQUEST | ai_core側で処理 | 0604を返す | **高** - 一貫性なし |

### 詳細分析

#### HANDOFF_YES / HANDOFF_NO / HANDOFF_REQUEST (深刻度: 高)
- **現状**: `select_template_ids()` が空リスト `[]` を返す
- **問題**: 
  - Intent判定とテンプレート選択の責務が分離されていない
  - ai_core側で特別処理が必要になり、保守性が低い
  - 他のIntentと一貫性がない
- **推奨**: 
  - HANDOFF_YES: ["081", "082"] を返す
  - HANDOFF_NO: ["086", "087"] を返す
  - HANDOFF_REQUEST: ["0604"] を返す

---

## 問題カテゴリC: 複雑な条件分岐 (保守性が低い)

| Intent | 分岐数 | 分岐条件の例 | 問題の深刻度 |
|--------|--------|------------|------------|
| FUNCTION | 8分岐 | "セキュリティ" / "間違" / "転送" / "個人情報" / "他の店" / "飲食" / "サポート" / デフォルト | **高** - 複雑すぎる |
| PRICE | 7分岐 | "初期費用" / "最低契約" / "解約" / "トライアル" / "人件費" / "ストレス" / "金額" | **高** - 複雑すぎる |
| INQUIRY | 5分岐 | "システム" / "ホームページ" / "システム導入したい" / "導入" / "飲食" | **高** - 複雑すぎる |
| RESERVATION | 4分岐 | "ダブルブッキング" / "席" / "スタッフ別" / "予約" | 中 |
| SETUP | 3分岐 | "すぐ使える" / "転送先番号" / "どうやって" | 中 |
| SUPPORT | 2分岐 | "不具合" / デフォルト | 低 |
| SALES_CALL | 2分岐 | "営業" / デフォルト | 低 |

### 詳細分析

#### FUNCTION (深刻度: 高)
- **現状**: 8つの条件分岐
- **問題**: 
  - 条件が多すぎて保守が困難
  - 条件の優先順位が不明確
  - 重複する条件がある（例: "個人情報" が2回チェック）
- **推奨**: 1つのテンプレートに統一（例: "023" のみ）

#### PRICE (深刻度: 高)
- **現状**: 7つの条件分岐
- **問題**: 
  - 料金に関する質問が細かく分岐しすぎ
  - ユーザーが「料金について」と聞いただけなのに、細かい条件分岐が必要
- **推奨**: 1つのテンプレートに統一（例: "040" のみ）

#### INQUIRY (深刻度: 高)
- **現状**: 5つの条件分岐
- **問題**: 
  - 問い合わせの種類が多すぎる
  - "システム" と "ホームページ" で異なるテンプレートを返す理由が不明確
- **推奨**: 1つのテンプレートに統一（例: "006" のみ）

---

## 問題カテゴリD: テンプレート重複 (Intentの意味が曖昧)

| テンプレートID | 使用しているIntent | 問題の深刻度 |
|--------------|------------------|------------|
| "085" | RESERVATION, MULTI_STORE, DIALECT, INTERRUPT, SYSTEM_EXPLAIN | **高** - 5つのIntentで使用 |
| "006_SYS" | SYSTEM_INQUIRY, INQUIRY | 中 - 2つのIntentで使用 |
| "023" | SYSTEM_EXPLAIN, FUNCTION | 中 - 2つのIntentで使用 |
| "0280", "0281", "0283" | INQUIRY, FUNCTION | 中 - 2つのIntentで使用 |
| "086", "087" | END_CALL, HANDOFF_NO (ai_core側) | 中 - 終了とハンドオフ拒否で同じ |

### 詳細分析

#### "085" テンプレート (深刻度: 高)
- **内容**: "ほかに気になる点はありますか？"
- **使用Intent**: 
  - RESERVATION: ["070", "085"]
  - MULTI_STORE: ["069", "085"]
  - DIALECT: ["066", "085"]
  - INTERRUPT: ["065", "085"]
  - SYSTEM_EXPLAIN: ["020", "023", "021", "085"]
- **問題**: 
  - 5つの異なるIntentで同じテンプレートを使用
  - Intentの意味が曖昧になる
  - すべてのIntentで「追加質問を促す」という同じパターン
- **推奨**: "085" を削除し、各Intentで1つのテンプレートのみ返す

#### "006_SYS" テンプレート (深刻度: 中)
- **内容**: "ありがとうございます。システムについてですね。どのような点が気になっていますか？"
- **使用Intent**: 
  - SYSTEM_INQUIRY: ["006_SYS"]
  - INQUIRY: ["006_SYS"] (条件: "システム" を含む場合)
- **問題**: 
  - SYSTEM_INQUIRY と INQUIRY の境界が曖昧
  - 同じテンプレートを使うなら、Intentを統合すべき
- **推奨**: SYSTEM_INQUIRY と INQUIRY を統合、または明確に分離

---

## その他の問題点

### 1. 重複コード
- **AI_CALL_TOPIC**: 670行目と694行目で重複定義
- **SETUP_DIFFICULTY**: 690行目と698行目で重複定義
- **問題**: コードの重複により保守性が低下

### 2. ランダム選択
- **INQUIRY_PASSIVE**: `random.choice([["089"], ["090"]])` でランダム選択
- **問題**: 
  - 同じ入力に対して異なる応答が返る可能性
  - テストが困難
  - デバッグが困難

### 3. UNKNOWN Intentの処理
- **現状**: UNKNOWN の場合 ["114"] を返す
- **問題**: 
  - ユーザーが理解できない発話に対して「ご要件をもう一度お伺いしてもよろしいでしょうか？」と返すのは適切か？
  - より適切なテンプレート（例: "110"）の方が良い可能性

---

## 修正優先度の推奨

### 最優先 (深刻度: 高)
1. **空リストを返すIntentの修正** (HANDOFF_YES, HANDOFF_NO, HANDOFF_REQUEST)
   - 一貫性を保つため、必ずテンプレートを返すように修正
   
2. **複数テンプレートを返すIntentの統一** (SYSTEM_EXPLAIN, END_CALL)
   - 4つ/3つは長すぎるため、1つに統一

3. **複雑な条件分岐の削減** (FUNCTION, PRICE, INQUIRY)
   - 8分岐/7分岐/5分岐は複雑すぎるため、1つのテンプレートに統一

4. **"085" テンプレートの削除**
   - 5つのIntentで使用されているため、各Intentで1つのテンプレートのみ返すように修正

### 中優先 (深刻度: 中)
5. **重複コードの削除** (AI_CALL_TOPIC, SETUP_DIFFICULTY)
6. **テンプレート重複の解消** ("006_SYS", "023", "0280"など)

### 低優先 (深刻度: 低)
7. **ランダム選択の見直し** (INQUIRY_PASSIVE)
8. **UNKNOWN Intentの処理見直し**

---

## 修正後の理想的な構造

### 原則
1. **1 Intent = 1 Primary Template** (原則)
2. **空リスト禁止**: すべてのIntentで必ずテンプレートを返す
3. **条件分岐の削減**: Intentを細分化して条件分岐を減らす
4. **テンプレート重複の削減**: 各Intentで固有のテンプレートを使用

### 修正例

```python
# 修正前
if intent == "SYSTEM_EXPLAIN":
    return ["020", "023", "021", "085"]  # 4つ

# 修正後
if intent == "SYSTEM_EXPLAIN":
    return ["020"]  # 1つに統一
```

```python
# 修正前
if intent == "HANDOFF_YES":
    return []  # 空リスト

# 修正後
if intent == "HANDOFF_YES":
    return ["081", "082"]  # 明示的に返す
```

```python
# 修正前
if intent == "FUNCTION":
    if contains("セキュリティ", "個人情報"):
        return ["063"]
    if contains("間違", "クレーム"):
        return ["021"]
    # ... 8つの分岐

# 修正後
if intent == "FUNCTION":
    return ["023"]  # 1つに統一
```

