# Intent分類とテンプレートマッピング 現状整理ドキュメント

## 概要

このドキュメントは、LibertyCall GatewayのIntent分類とテンプレートマッピングの現状を整理したものです。
複雑化した設計を可視化し、シンプルな設計への再構築の基礎資料として使用します。

**作成日**: 2025-12-27  
**対象ファイル**: 
- `libertycall/gateway/intent_rules.py`
- `config/clients/000/flow.json`

---

## 1. 全Intentリストと判定条件

### 1.1 優先度順（classify_intent関数の実行順序）

| 優先度 | Intent | 判定条件 | キーワード/関数 | 備考 |
|--------|--------|---------|---------------|------|
| 1 | NOT_HEARD | ノイズ・聞き取れない | `_is_noise()`: "ゴニョゴニョ"、特殊文字3文字以上 | 最優先 |
| 2 | HANDOFF_YES | ハンドオフ確認中の肯定応答 | `context="handoff_confirming"` + `_is_ack_response()` | コンテキスト依存 |
| 3 | HANDOFF_NO | ハンドオフ確認中の否定応答 | `context="handoff_confirming"` + `HANDOFF_NO_KEYWORDS` | コンテキスト依存 |
| 4 | SYSTEM_INQUIRY | システムについての問い合わせ | "システムについて"、"システムの"、"システムを"等 | ハンドオフより優先 |
| 5 | HANDOFF_REQUEST | 担当者への接続希望 | `_has_handoff_intent()`: 名詞+動詞/依頼表現 | 複雑な判定ロジック |
| 6 | INQUIRY_PASSIVE | 温度の低いリード | `LOW_INTENT_KEYWORDS`: "まだ検討中"、"迷っている"等 | 問い合わせより優先 |
| 7 | INQUIRY | 問い合わせ | `_has_inquiry_intent()`: ホームページ、メール、システム、サービス等 | |
| 8 | GREETING | 挨拶 | `_is_greeting()`: "もしもし"、"こんにちは"等 | |
| 9 | SALES_CALL | 営業電話 | "営業"、"ご提案"、"サービスのご提案" | |
| 10 | PRICE | 料金 | `PRICE_KEYWORDS`: "金額"、"料金"、"値段"、"月額"等 | |
| 11 | SETUP | 設定 | `SETUP_KEYWORDS`: "導入したら"、"いつから"、"どれくらい"等 | |
| 12 | FUNCTION | 機能 | `FUNCTION_KEYWORDS`: "aiの声"、"転送"、"予約管理"等 | |
| 13 | SUPPORT | サポート | `SUPPORT_KEYWORDS`: "サポート"、"不具合"、"エラー"等 | |
| 14 | END_CALL | 終了 | `END_CALL_KEYWORDS`: "もうだいじょうぶ"、"大丈夫です"等 | |
| 15 | AI_CALL_TOPIC | AI電話の件 | "ai電話"、"aiの電話"、"aiの件"等 | |
| 16 | AI_IDENTITY | AIの正体 | "aiがやってる"、"aiですか"、"ロボット"等 | |
| 17 | SETUP_DIFFICULTY | 設定難易度 | "設定むずい"、"設定難しい"等 | |
| 18 | SYSTEM_EXPLAIN | システム説明 | "どういうシステム"、"どんなシステム"等 | |
| 19 | BUSY | 混雑 | "混んでます"、"混んでる"、"込み合って"等 | |
| 20 | CALLBACK_REQUEST | 折り返し | "折り返し"、"折り返して"、"かけ直し"等 | |
| 21 | DIALECT | 方言 | "関西弁"、"方言"、"イントネーション" | |
| 22 | INTERRUPT | 割り込み | "口挟ん"、"割り込ん"、"途中で話しても"等 | |
| 23 | RESERVATION | 予約機能 | "予約"、"キャンセル"、"ダブルブッキング"等 | |
| 24 | MULTI_STORE | 複数店舗 | "店舗いくつか"、"複数店舗"、"別店舗"等 | |
| 25 | UNKNOWN | 不明 | 上記すべてに該当しない場合 | デフォルト |

---

## 2. Intent別テンプレートマッピング

### 2.1 テンプレート選択ロジック（select_template_ids関数）

| Intent | 返すテンプレート | テンプレート内容 | 条件分岐 | 問題点 |
|--------|----------------|----------------|---------|--------|
| **NOT_HEARD** | `["0602"]` | "恐れ入ります、少し聞き取りづらかったようです。もう一度お願いできますでしょうか？" | なし | ✅ 1つ |
| **HANDOFF_YES** | `[]` | （空リスト） | なし | ⚠️ ai_core側で081+082を返す |
| **HANDOFF_NO** | `[]` | （空リスト） | なし | ⚠️ ai_core側で086+087を返す |
| **SALES_CALL** | `["094", "088"]` または `["093"]` | 094: "恐れ入りますが、営業目的のご連絡はお受けしておりません。"<br>088: "失礼いたします。"<br>093: "営業目的のお電話でしょうか？" | "営業"、"はい営業"を含む場合 | ⚠️ 2つ返す場合あり |
| **AI_CALL_TOPIC** | `["0600"]` | "AI電話の件ですね。どのあたりが気になっておりますでしょうか？" | なし | ✅ 1つ |
| **AI_IDENTITY** | `["023_AI_IDENTITY"]` | "はい、私がAIで自動応答させていただいております。内容によっては担当者におつなぎする場合もございますが、わかる範囲でご案内いたします。" | なし | ✅ 1つ |
| **SYSTEM_EXPLAIN** | `["020", "023", "021", "085"]` | 020: "当社のAI電話は二十四時間三百六十五日対応で..."<br>023: "AIが電話応対し、必要に応じて担当者へ引き継ぎます。"<br>021: "誤案内防止のため、ルールベース方式を採用しています。"<br>085: "ほかに気になる点はありますか？" | なし | ❌ **4つ返す** |
| **BUSY** | `["090", "098"]` | 090: "現在込み合っております。"<br>098: "順番にご案内しておりますのでお待ちください。" | なし | ⚠️ 2つ返す |
| **CALLBACK_REQUEST** | `["0601"]` | "承知いたしました。折り返し希望として承ります。お名前とご連絡先をお伺いしてもよろしいでしょうか？" | なし | ✅ 1つ |
| **SETUP_DIFFICULTY** | `["0603"]` | "初期設定はこちらで代行いたしますので、お店側の作業はほとんどございません。スマホだけでもご利用いただけますのでご安心ください。" | なし | ✅ 1つ |
| **DIALECT** | `["066", "085"]` | 066: "方言やイントネーションにも柔軟に対応いたします。"<br>085: "ほかに気になる点はありますか？" | なし | ⚠️ 2つ返す |
| **INTERRUPT** | `["065", "085"]` | 065: "リアルタイムで発話割り込みに対応いたします。"<br>085: "ほかに気になる点はありますか？" | なし | ⚠️ 2つ返す |
| **RESERVATION** | `["071", "085"]` または `["072", "085"]` または `["070", "085"]` | 071: "ダブルブッキングを避けるように自動で枠を管理します。"<br>072: "席数やスタッフごとの予約枠も設定いただけます。"<br>070: "予約の取得や変更、キャンセルにも柔軟に対応可能です。"<br>085: "ほかに気になる点はありますか？" | "ダブルブッキング" / "席" / "スタッフ別" / その他 | ⚠️ 常に2つ返す |
| **MULTI_STORE** | `["069", "085"]` | 069: "複数拠点・複数番号の管理にも対応しております。"<br>085: "ほかに気になる点はありますか？" | なし | ⚠️ 2つ返す |
| **GREETING** | `["004"]` | "もしもし。" | なし | ✅ 1つ（修正済み） |
| **SYSTEM_INQUIRY** | `["006_SYS"]` | "ありがとうございます。システムについてですね。どのような点が気になっていますか？" | なし | ✅ 1つ |
| **INQUIRY** | `["006_SYS"]` または `["006"]` または `["006", "010"]` または `["0280", "0281", "0283"]` | 006_SYS: "ありがとうございます。システムについてですね。どのような点が気になっていますか？"<br>006: "導入のご相談でよろしかったでしょうか？"<br>010: "どのような点が気になっておりますでしょうか？"<br>0280-0283: 導入実績関連 | "システム" / "ホームページ"等 / "導入" / "飲食"等 / デフォルト | ❌ **複雑な分岐、2つ返す場合あり** |
| **INQUIRY_PASSIVE** | `["089"]` または `["090"]` | 089: "ありがとうございます。ちなみに、どのあたりがご不安でしたか？"<br>090: "かしこまりました。どこか気になる点や迷っている部分はございますか？" | ランダム選択 | ✅ 1つ（ランダム） |
| **PRICE** | `["042"]` または `["045"]` または `["046"]` または `["029"]` または `["049", "048", "047"]` または `["040"]` | 042: "初期費用は一切かかりません。"<br>045: "最低契約期間はございません。"<br>046: "月途中でもすぐにご解約いただけます。"<br>029: "導入後一週間以内で動作不良などあれば全額返金が可能です。"<br>049,048,047: コスト削減関連<br>040: "料金は月額二十万円となります。" | "初期費用" / "最低契約" / "解約" / "トライアル"等 / "人件費"等 / "金額"等 / デフォルト | ⚠️ 3つ返す場合あり |
| **SETUP** | `["060"]` または `["061"]` | 060: "最短即日から導入が可能です。"<br>061: "必要なのは転送先番号のご指定のみです。" | "すぐ使える"等 / "転送先番号"等 / デフォルト | ✅ 1つ |
| **FUNCTION** | `["063"]` または `["021"]` または `["023"]` または `["0280", "0283"]` または `["0280", "0281", "0283"]` または `["0284"]` または `["026"]` | 063: "録音データは安全に管理されます。"<br>021: "誤案内防止のため、ルールベース方式を採用しています。"<br>023: "AIが電話応対し、必要に応じて担当者へ引き継ぎます。"<br>0280-0283: 導入実績関連<br>0284: "導入後もチャット・電話でのサポートが可能です。"<br>026: "お客様ごとに応答ルールと音声を調整し、精度を継続的に改善いたします。" | "セキュリティ" / "間違" / "転送" / "他の店" / "飲食"等 / "サポート" / デフォルト | ⚠️ 3つ返す場合あり |
| **SUPPORT** | `["0285"]` または `["0284"]` | 0285: "不具合があれば即日対応し、自動復旧機能も備えています。"<br>0284: "導入後もチャット・電話でのサポートが可能です。" | "不具合"等 / デフォルト | ✅ 1つ |
| **END_CALL** | `["086", "087", "088"]` | 086: "お電話ありがとうございました。"<br>087: "また何かあればいつでもご相談くださいね。"<br>088: "失礼いたします。" | なし | ⚠️ 3つ返す |
| **UNKNOWN** | `["114"]` | "ご要件をもう一度お伺いしてもよろしいでしょうか？" | なし | ✅ 1つ（修正済み） |
| **HANDOFF_REQUEST** | `[]` | （空リスト） | なし | ⚠️ ai_core側で0604を返す |
| **（フォールバック）** | `["110"]` | "もしもし？お声が遠いようです。もう一度お願いします。" | 上記すべてに該当しない場合 | ✅ 1つ |

---

## 3. Phase別テンプレートリスト（flow.json）

| Phase | テンプレートリスト | 備考 |
|-------|------------------|------|
| **ENTRY** | `["004", "005"]` | 初期フェーズ（修正前は005も含む） |
| **ENTRY_CONFIRM** | `["006"]` | エントリー確認 |
| **WAITING** | `[]` | ユーザー返答待ち（空リスト） |
| **NOT_HEARD** | `["110"]` | 聞き取れなかった |
| **QA** | `["006_SYS", "010", "020", "021", "022", "023", "040", "041", "042", "060", "061", "062", "089", "090", "110"]` | **15個のテンプレート**（複雑） |
| **AFTER_085** | `["085"]` | フォローアップ |
| **CLOSING** | `["084"]` | クロージング |
| **HANDOFF** | `["060", "061", "062", "104"]` | ハンドオフ開始 |
| **HANDOFF_CONFIRM_WAIT** | `["0604", "081", "082", "086", "087"]` | ハンドオフ確認待ち |
| **HANDOFF_DONE** | `["081", "082"]` | ハンドオフ完了 |
| **END** | `["086", "087", "088"]` | 会話終了 |

---

## 4. Phase遷移とIntentの関係

### 4.1 ENTRY Phase

| 条件 | 遷移先 | 備考 |
|------|--------|------|
| `intent == 'NOT_HEARD'` または `intent == 'GREETING'` | QA | |
| ENTRY_TRIGGER_KEYWORDS を含む | ENTRY_CONFIRM | |
| その他 | QA | |

### 4.2 QA Phase

| 条件 | 遷移先 | 備考 |
|------|--------|------|
| `intent == 'NOT_HEARD'` | NOT_HEARD | |
| `intent == 'SALES_CALL' && 初回` | AFTER_085 | |
| `intent == 'END_CALL'` | END | |
| `intent == 'HANDOFF_REQUEST'` | HANDOFF_CONFIRM_WAIT | |
| `intent == 'INQUIRY_PASSIVE'` | QA | QA継続（089/090を返す） |
| その他（INQUIRY, UNKNOWN 含む） | QA | **QA継続** |

### 4.3 NOT_HEARD Phase

| 条件 | 遷移先 | 備考 |
|------|--------|------|
| その他 | QA | |

---

## 5. 問題点の整理

### 5.1 複数テンプレートを返すIntent

| Intent | 返すテンプレート数 | 問題点 |
|--------|------------------|--------|
| SYSTEM_EXPLAIN | **4つ** | 長すぎる、ユーザーが混乱 |
| INQUIRY | 1-3つ（条件分岐） | 複雑すぎる、2つ返す場合あり |
| PRICE | 1-3つ（条件分岐） | 3つ返す場合あり |
| FUNCTION | 1-3つ（条件分岐） | 3つ返す場合あり |
| RESERVATION | **常に2つ** | 085が常に付く |
| MULTI_STORE | **常に2つ** | 085が常に付く |
| DIALECT | **常に2つ** | 085が常に付く |
| INTERRUPT | **常に2つ** | 085が常に付く |
| BUSY | **常に2つ** | |
| SALES_CALL | 1-2つ（条件分岐） | |
| END_CALL | **3つ** | |

### 5.2 空リストを返すIntent

| Intent | 返すテンプレート | 問題点 |
|--------|----------------|--------|
| HANDOFF_YES | `[]` | ai_core側で081+082を返す（一貫性なし） |
| HANDOFF_NO | `[]` | ai_core側で086+087を返す（一貫性なし） |
| HANDOFF_REQUEST | `[]` | ai_core側で0604を返す（一貫性なし） |

### 5.3 QA Phaseのテンプレートリストが複雑

- **15個のテンプレート**が定義されている
- UNKNOWN intent時に、リストの最初の要素（`006_SYS`）が自動選択される問題（修正済み）
- 複数のテンプレートから選択するロジックが複雑

### 5.4 設計上の問題

1. **Intent分類が25種類**と多すぎる
2. **条件分岐が複雑**（特にINQUIRY、PRICE、FUNCTION）
3. **同じIntentで複数テンプレートを返す**設計が一貫していない
4. **空リストを返すIntent**があり、ai_core側で処理する必要がある
5. **PhaseとIntentの関係**が複雑（QA phaseで多くのIntentが継続）

---

## 6. 推奨される改善方針

### 6.1 シンプル化の原則

1. **1 Intent = 1 テンプレート**を原則とする
2. **複数テンプレートが必要な場合は、新しいIntentを作る**
3. **空リストを返さない**（すべてのIntentでテンプレートを返す）
4. **条件分岐を最小化**する

### 6.2 具体的な改善案

#### 6.2.1 複数テンプレートを返すIntentの整理

- **SYSTEM_EXPLAIN**: 4つ → 1つに統合、または複数のIntentに分割
- **INQUIRY**: 条件分岐を簡素化、1つに統一
- **PRICE**: 条件分岐を簡素化、1つに統一
- **FUNCTION**: 条件分岐を簡素化、1つに統一
- **RESERVATION, MULTI_STORE, DIALECT, INTERRUPT**: 085を削除、1つに統一
- **BUSY**: 1つに統一
- **END_CALL**: 1つに統一

#### 6.2.2 空リストを返すIntentの修正

- **HANDOFF_YES**: `["081", "082"]`を返す
- **HANDOFF_NO**: `["086", "087"]`を返す
- **HANDOFF_REQUEST**: `["0604"]`を返す

#### 6.2.3 QA Phaseのテンプレートリストの簡素化

- テンプレートリストを削除し、Intentベースで選択する
- または、テンプレートリストを最小限に絞る

#### 6.2.4 Intent分類の簡素化

- 25種類 → 10-15種類程度に統合
- 類似のIntentを統合（例: SETUP + SETUP_DIFFICULTY）

---

## 7. 次のステップ

1. **このドキュメントを基に、シンプルな設計案を作成**
2. **段階的にリファクタリング**（一度に全部変更しない）
3. **テストケースを作成**して動作確認
4. **ログを分析**して、実際の使用頻度を確認

---

## 付録: テンプレート内容一覧（主要なもの）

| テンプレートID | 内容 |
|--------------|------|
| 004 | もしもし。 |
| 005 | ありがとうございます。どのようなご用件でしょうか？ |
| 006 | 導入のご相談でよろしかったでしょうか？ |
| 006_SYS | ありがとうございます。システムについてですね。どのような点が気になっていますか？ |
| 010 | どのような点が気になっておりますでしょうか？ |
| 020 | 当社のAI電話は二十四時間三百六十五日対応で、一次受付から要件確認まで自動で行います。 |
| 021 | 誤案内防止のため、ルールベース方式を採用しています。 |
| 022 | 想定外の内容は、全て担当者へ即転送する安全設計です。 |
| 023 | AIが電話応対し、必要に応じて担当者へ引き継ぎます。 |
| 040 | 料金は月額二十万円となります。 |
| 042 | 初期費用は一切かかりません。 |
| 060 | 最短即日から導入が可能です。 |
| 061 | 必要なのは転送先番号のご指定のみです。 |
| 085 | ほかに気になる点はありますか？ |
| 086 | お電話ありがとうございました。 |
| 087 | また何かあればいつでもご相談くださいね。 |
| 088 | 失礼いたします。 |
| 089 | ありがとうございます。ちなみに、どのあたりがご不安でしたか？ |
| 090 | かしこまりました。どこか気になる点や迷っている部分はございますか？ |
| 110 | もしもし？お声が遠いようです。もう一度お願いします。 |
| 114 | ご要件をもう一度お伺いしてもよろしいでしょうか？ |
| 0602 | 恐れ入ります、少し聞き取りづらかったようです。もう一度お願いできますでしょうか？ |
| 0604 | 私では詳細のご案内が難しい内容のため、担当者におつなぎしてもよろしいでしょうか？ |

---

**このドキュメントは、設計の再構築の基礎資料として使用してください。**

