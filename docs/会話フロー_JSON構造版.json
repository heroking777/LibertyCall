{
  "version": "2.0",
  "updated_at": "2025-12-05",
  "description": "LibertyCall 会話フロー定義（修正版）",
  
  "phases": {
    "ENTRY": {
      "name": "初期フェーズ",
      "description": "通話開始時の最初のフェーズ",
      "transitions": [
        {
          "condition": "intent == 'NOT_HEARD' || intent == 'GREETING'",
          "target": "QA"
        },
        {
          "condition": "ENTRY_TRIGGER_KEYWORDS を含む",
          "target": "ENTRY_CONFIRM"
        },
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["004", "005"]
    },
    
    "ENTRY_CONFIRM": {
      "name": "エントリー確認",
      "description": "ホームページ/メールなどのキーワードが検出された場合の確認フェーズ",
      "transitions": [
        {
          "condition": "CLOSING_YES_KEYWORDS を含む",
          "target": "HANDOFF",
          "note": "営業フェーズへ"
        },
        {
          "condition": "CLOSING_NO_KEYWORDS を含む",
          "target": "END"
        },
        {
          "condition": "user_reply_received == True",
          "target": "QA",
          "note": "ユーザー返答あり"
        },
        {
          "condition": "user_reply_received == False",
          "target": "WAITING",
          "note": "ユーザー返答待ち"
        }
      ],
      "templates": ["006"],
      "wait_time_after": 1.8,
      "note": "テンプレート006発話後、1.8秒待機してからWAITINGフェーズへ"
    },
    
    "WAITING": {
      "name": "ユーザー返答待ち",
      "description": "AI発話後のユーザー返答を待つフェーズ（1.5〜2.0秒待機）",
      "transitions": [
        {
          "condition": "user_voice_detected == True",
          "target": "QA",
          "note": "ユーザー音声検知"
        },
        {
          "condition": "user_voice_detected == False && timeout",
          "target": "NOT_HEARD",
          "note": "返答なし → NOT_HEARD"
        }
      ],
      "templates": [],
      "human_wait_time": 1.8,
      "note": "1.8秒待機中にユーザー音声を検知したらQAへ、なければNOT_HEARDへ"
    },
    
    "NOT_HEARD": {
      "name": "聞き取れなかった",
      "description": "ユーザー返答が検知できなかった場合のフェーズ",
      "transitions": [
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["110"]
    },
    
    "QA": {
      "name": "質問応答フェーズ",
      "description": "通常の会話・質問への対応フェーズ",
      "transitions": [
        {
          "condition": "intent == 'SALES_CALL' && 初回",
          "target": "AFTER_085"
        },
        {
          "condition": "intent == 'END_CALL'",
          "target": "END"
        },
        {
          "condition": "intent == 'HANDOFF_REQUEST'",
          "target": "HANDOFF_CONFIRM_WAIT"
        },
        {
          "condition": "intent == 'INQUIRY_PASSIVE'",
          "target": "QA",
          "note": "温度の低いリード → QA継続（089/090を返す）"
        },
        {
          "condition": "その他（INQUIRY, UNKNOWN 含む）",
          "target": "QA",
          "note": "QA継続"
        }
      ],
      "templates": ["006_SYS", "010", "020", "021", "022", "023", "040", "041", "042", "060", "061", "062", "089", "090", "110"]
    },
    
    "AFTER_085": {
      "name": "フォローアップ",
      "description": "SALES_CALLや通常応答後のフォローフェーズ",
      "transitions": [
        {
          "condition": "intent == 'HANDOFF_REQUEST'",
          "target": "HANDOFF_CONFIRM_WAIT"
        },
        {
          "condition": "AFTER_085_NEGATIVE_KEYWORDS を含む",
          "target": "CLOSING"
        },
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["085"]
    },
    
    "CLOSING": {
      "name": "クロージング",
      "description": "最終確認・転送判断フェーズ",
      "transitions": [
        {
          "condition": "CLOSING_YES_KEYWORDS を含む",
          "target": "HANDOFF"
        },
        {
          "condition": "CLOSING_NO_KEYWORDS を含む",
          "target": "END"
        },
        {
          "condition": "その他",
          "target": "QA"
        }
      ],
      "templates": ["084"]
    },
    
    "HANDOFF": {
      "name": "ハンドオフ開始",
      "description": "担当者転送の開始フェーズ",
      "transitions": [
        {
          "condition": "自動遷移（060/061/062/104 を返した後）",
          "target": "HANDOFF_CONFIRM_WAIT"
        }
      ],
      "templates": ["060", "061", "062", "104"]
    },
    
    "HANDOFF_CONFIRM_WAIT": {
      "name": "ハンドオフ確認待ち",
      "description": "転送確認のYES/NO待ちフェーズ",
      "transitions": [
        {
          "condition": "intent == 'HANDOFF_YES' || HANDOFF_FALLBACK_YES",
          "target": "HANDOFF_DONE",
          "note": "転送実行"
        },
        {
          "condition": "intent == 'HANDOFF_NO' || HANDOFF_FALLBACK_NO",
          "target": "END"
        },
        {
          "condition": "あいまい応答 && retry == 0",
          "target": "HANDOFF_CONFIRM_WAIT",
          "note": "0604を再提示"
        },
        {
          "condition": "あいまい応答 && retry >= 1",
          "target": "END",
          "note": "安全側で終了"
        }
      ],
      "templates": ["0604", "081", "082", "086", "087"]
    },
    
    "HANDOFF_DONE": {
      "name": "ハンドオフ完了",
      "description": "転送実行済みフェーズ",
      "transitions": [
        {
          "condition": "転送完了",
          "target": null,
          "note": "PBX転送処理で通話が移るため、END遷移は省略"
        }
      ],
      "templates": ["081", "082"]
    },
    
    "END": {
      "name": "会話終了",
      "description": "会話終了フェーズ。自動切断タイマー（60秒）がセットされる",
      "transitions": [],
      "templates": ["086", "087", "088"]
    }
  },
  
  "keywords": {
    "ENTRY_TRIGGER_KEYWORDS": [
      "ホームページ", "HP", "LP", "DM", "メール", "メッセージ", "案内", "連絡"
    ],
    
    "AFTER_085_NEGATIVE_KEYWORDS": [
      "もうだいじょうぶ", "大丈夫です", "ほかはない", "以上です", "けっこうです",
      "たぶんいい", "質問ない", "他にない"
    ],
    
    "CLOSING_YES_KEYWORDS": [
      "はい", "お願いします", "頼む", "教えて", "知りたい", "聞きたい",
      "うん", "いいよ", "ぜひ", "進めて", "案内して"
    ],
    
    "CLOSING_NO_KEYWORDS": [
      "今日はいい", "今日は聞くだけ", "また考える", "検討する", "やめとく",
      "不要", "いりません", "結構です", "遠慮します", "やめます", "また連絡"
    ],
    
    "HANDOFF_REQUEST_KEYWORDS": [
      "担当者", "たんとうしゃ", "担当の者", "当者", "人間", "オペレーター",
      "ひとにつないで", "人につないで", "繋ぐ", "つなぐ", "回す", "まわす",
      "代わる", "変わる", "人と話したい", "ひとと話したい"
    ],
    
    "LOW_INTENT_KEYWORDS": [
      "いやまだそこまでは",
      "まだ検討中",
      "様子を見てる",
      "今のところ考えてない",
      "導入までは考えてない",
      "検討してるところ",
      "迷っている",
      "まだ決めてない",
      "検討中です",
      "考え中",
      "様子見"
    ]
  },
  
  "templates": {
    "005": {
      "text": "ありがとうございます。どのようなご用件でしょうか？",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "note": "修正版：口語調に変更"
    },
    "006": {
      "text": "導入のご相談でよろしかったでしょうか？",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "wait_time_after": 1.8,
      "note": "修正版：口語調に変更、発話後1.8秒待機"
    },
    "089": {
      "text": "ありがとうございます。ちなみに、どのあたりがご不安でしたか？",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "note": "新規：温度の低いリード対応（検討中ユーザーへの柔らかい質問）"
    },
    "090": {
      "text": "かしこまりました。どこか気になる点や迷っている部分はございますか？",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "note": "新規：温度の低いリード対応（検討中ユーザーへの柔らかい質問）"
    },
    "085": {
      "text": "ほかに気になる点はありますか？",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "note": "修正版：口語調に変更"
    },
    "086": {
      "text": "お電話ありがとうございました。",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "note": "修正版：口語調に変更"
    },
    "087": {
      "text": "また何かあればいつでもご相談くださいね。",
      "voice": "ja-JP-Neural2-B",
      "rate": 1.1,
      "note": "修正版：口語調に変更"
    }
  },
  
  "handoff_flow": {
    "states": ["idle", "confirming", "done"],
    "transitions": {
      "idle -> confirming": [
        "HANDOFF_REQUEST",
        "UNKNOWN && handoff_prompt_sent == false",
        "not_heard_streak >= 2",
        "unclear_streak >= 2"
      ],
      "confirming -> done": [
        "HANDOFF_YES (明示的 or YESっぽいフレーズ)",
        "HANDOFF_NO (明示的 or NOっぽいフレーズ)",
        "あいまい応答(2回目以降) -> 安全側で終了"
      ],
      "confirming -> confirming": [
        "あいまい応答(最初の1回) -> 0604 を再度出す (handoff_retry_count=0 -> 1)"
      ],
      "done -> confirming": [
        "handoff_state=done だが再度 HANDOFF_REQUEST が来たとき 0604 再提示"
      ]
    },
    "confirmation_flow": {
      "explicit_yes": {
        "action": "転送実行",
        "templates": ["081", "082"],
        "transfer_requested": true
      },
      "explicit_no": {
        "action": "終了",
        "templates": ["086", "087"],
        "transfer_requested": false
      },
      "ambiguous_first": {
        "retry_count": 0,
        "action": "再確認",
        "templates": ["0604"],
        "transfer_requested": false
      },
      "ambiguous_retry": {
        "retry_count": ">= 1",
        "action": "安全側で終了",
        "templates": ["086", "087"],
        "transfer_requested": false,
        "note": "修正版：転送ではなく終了に変更"
      }
    }
  },
  
  "changes_summary": {
    "flow_changes": [
      {
        "phase": "ENTRY_CONFIRM",
        "change": "YES → HANDOFF、NO → END に変更",
        "reason": "ENTRY_CONFIRM は「導入相談でよろしいですか？」の確認なので、YESであれば営業フェーズ（HANDOFF or QA）に、NOなら終了するのが自然"
      },
      {
        "phase": "QA",
        "change": "SALES_CALL初回のみ AFTER_085 へ、その他は QA 継続",
        "reason": "AFTER_085 は「フォローアップ」専用なので、通常のQA応答が自動でAFTER_085へ行くのは制御が曖昧になる"
      },
      {
        "phase": "AFTER_085",
        "change": "handoff_state 条件を削除、シンプル化",
        "reason": "実運用では HANDOFF_REQUEST が発火した時点で handoff_state を新規化するため、条件は冗長"
      },
      {
        "phase": "HANDOFF_CONFIRM_WAIT",
        "change": "あいまい応答2回目以降は END（安全終了）",
        "reason": "「転送しないで終了」の方がクレーム回避に安全。本当に転送希望なら明示的YESが出る"
      },
      {
        "phase": "HANDOFF_DONE",
        "change": "END遷移を削除",
        "reason": "Handoff済みコールはAI側でENDフェーズに入る前に切断される"
      }
    ],
    "template_changes": [
      {
        "id": "005",
        "old": "恐れ入ります。ご用件をお伺いしてもよろしいでしょうか？",
        "new": "ありがとうございます。どのようなご用件でしょうか？",
        "reason": "口語調・自然音声読み上げ対応の文体にすることで、AI音声（TTS）の滑らかさとユーザー印象が向上"
      },
      {
        "id": "006",
        "old": "導入のご相談でよろしかったでしょうか？",
        "new": "導入のご相談ですね。はい、承知しました。",
        "reason": "口語調に変更"
      },
      {
        "id": "085",
        "old": "他に気になる点はございますでしょうか？",
        "new": "ほかに気になる点はありますか？",
        "reason": "口語調に変更"
      },
      {
        "id": "086",
        "old": "本日のご連絡ありがとうございました。",
        "new": "お電話ありがとうございました。",
        "reason": "口語調に変更"
      },
      {
        "id": "087",
        "old": "また何かございましたらいつでもお問い合わせください。",
        "new": "また何かあればいつでもご相談くださいね。",
        "reason": "口語調に変更"
      }
    ],
    "keyword_changes": [
      {
        "category": "HANDOFF_REQUEST_KEYWORDS",
        "change": "正規化済み・重複除去版に更新",
        "reason": "「繋ぐ／つなぐ」「代わる／変わる」などは正規化済み辞書で統一。リストを縮小して意図判定の精度を上げる"
      }
    ]
  }
}

