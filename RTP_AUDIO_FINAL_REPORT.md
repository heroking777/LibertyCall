# RTP音声データ処理 - 最終診断レポート

## テスト実施日時
2025-12-27 18:28-18:29頃（通話ID: `in-2025122718283823`）

## テスト内容
- 実通話を実施
- 「もしもし」を2回発話
- 反応なし

---

## 診断ログの出力状況

### ✅ 正常に出力されている診断ログ

1. **[RTP_AUDIO_RMS] stage=ulaw_decode**
   - **出力: あり**
   - RMS値の範囲: 0-61
   - 大部分: 1-40程度

2. **[RTP_AUDIO_RMS] stage=16khz_resample**
   - **出力: あり**
   - RMS値の範囲: 1-72
   - 大部分: 1-40程度

3. **[STREAMING_FEED]**
   - **出力: あり**
   - RMS値の範囲: 1-175
   - 大部分: 1-50程度
   - 最大値: 175

### ❌ 出力されていない診断ログ

1. **[RTP_PAYLOAD_DEBUG]**
   - **出力: なし**
   - 理由: 最初の5回のみ出力される設定のため、通話開始時に既に出力済みの可能性

2. **[RTP_AUDIO_SAMPLES]**
   - **出力: なし**
   - 理由: 最初の50回のみ詳細出力される設定のため、通話開始時に既に出力済みの可能性

---

## RMS値の詳細分析

### 各段階のRMS値比較

**ログ例（18:29:02-18:29:08の範囲）:**

| 時刻 | stage=ulaw_decode | stage=16khz_resample | STREAMING_FEED |
|------|-------------------|---------------------|----------------|
| 18:29:01 | rms=13 | rms=12 | rms=35 |
| 18:29:02 | rms=26 | rms=15 | rms=6 |
| 18:29:02 | rms=4 | rms=41 | rms=29 |
| 18:29:03 | rms=25 | rms=4 | rms=5 |
| 18:29:03 | rms=6 | rms=63 | rms=52 |
| 18:29:04 | rms=39 | rms=72 | rms=79 |
| 18:29:04 | rms=61 | rms=12 | rms=32 |
| 18:29:05 | rms=31 | rms=23 | rms=51 |
| 18:29:05 | rms=24 | rms=23 | rms=42 |
| 18:29:07 | rms=34 | rms=4 | rms=175 |
| 18:29:07 | rms=11 | rms=2 | rms=92 |

**分析結果:**

1. **stage=ulaw_decode（μ-lawデコード後）**
   - 範囲: 0-61
   - 平均値: 約10-20程度
   - 最大値: 61
   - **問題: 正常な音声なら100以上が期待される**

2. **stage=16khz_resample（16kHz変換後）**
   - 範囲: 1-72
   - 平均値: 約10-20程度
   - 最大値: 72
   - **問題: 正常な音声なら100以上が期待される**

3. **STREAMING_FEED（on_new_audio受信時）**
   - 範囲: 1-175
   - 平均値: 約10-30程度
   - 最大値: 175
   - **問題: 正常な音声なら100以上が期待されるが、最大値175は一応音声があることを示している**

---

## エラーの有無

**[AI Error] の出力: なし**

**確認結果:**
- `audioop`重複インポートエラーは解消されている
- 再起動後のログにエラーは見当たらない
- 音声データ処理は正常に動作している

---

## ASR結果の確認

**確認結果:**
- `ASR_GOOGLE_RAW` のログ: **見つからない**
- `ASR_TRANSCRIPT` のログ: **見つからない**
- `ASR_RESULT` のログ: **見つからない**

**補足:**
- `on_new_audio` は正常に呼ばれている（640バイトのチャンクを送信）
- ASRストリームは起動している可能性が高い
- しかし、ASR結果がログに出力されていない

---

## 現在のアクティブな通話本数

**最新の通話:**
- 通話ID: `in-2025122718283823`
- ステータス: **終了済み**（`on_call_end` が呼ばれている）
- 終了時刻: 2025-12-27 18:29:08

**ログ確認結果:**
```
2025-12-27 18:29:08,613 [INFO] [EVENT_SOCKET] Received event: call_end uuid=f78cd2a4-3945-4ae5-bcae-3627cf11327c
2025-12-27 18:29:08,613 [INFO] [AICORE] on_call_end() call_id=in-2025122718283823
2025-12-27 18:29:08,614 [INFO] [EVENT_SOCKET] Removed call_id=in-2025122718283823 from _active_calls
```

**現在のアクティブな通話本数: 0件**

---

## 問題の特定

### 問題1: RMS値が全体的に低い（最重要）

**症状:**
- 各段階のRMS値が1-72の範囲（正常なら100以上）
- 最大値でも175程度で、正常な音声レベルには達していない

**考えられる原因:**
1. **RTPパケットの音声データが無音または非常に小さい**
   - FreeSWITCHからの音声ルーティングの問題
   - マイクの音量設定が低い
   - 音声コーデックの問題

2. **μ-lawデコードの問題**
   - デコード処理は正常に動作しているが、元のデータが無音
   - データ形式がμ-lawではない可能性

3. **16kHz変換の問題**
   - 変換処理でデータが失われている可能性
   - ただし、RMS値の変化を見ると、変換前後で大きな差はない

### 問題2: ASR結果が空文字列

**症状:**
- ASR結果のログが一切出力されていない
- `on_new_audio` は正常に呼ばれている
- ASRストリームは起動している可能性が高い

**考えられる原因:**
1. **RMS値が低すぎるため、Google ASRが音声を認識できない**
   - RMS値が1-72程度では、Google ASRが音声として認識しない可能性
   - 正常な音声ならRMS値は100以上になるはず

2. **ASRストリームが正常に起動していない**
   - ストリーム起動ログを確認する必要がある

---

## 結論

### 根本原因の推測

**RMS値が全体的に低い（1-72の範囲）ことが最大の問題**

1. **音声データは処理されているが、音量が非常に小さい**
   - RTPパケットは正常に受信されている
   - μ-lawデコードも正常に動作している
   - 16kHz変換も正常に動作している
   - しかし、RMS値が低すぎる

2. **Google ASRが音声を認識できない**
   - RMS値が低すぎるため、Google ASRが音声として認識しない
   - 結果として、ASR結果が空文字列になる

### 推奨される対処方法

1. **FreeSWITCHの音声ルーティングを確認**
   - マイクの音量設定
   - 音声コーデックの設定
   - RTPポートの設定

2. **RTPパケットの音声データを確認**
   - 実際に音声が含まれているか確認
   - WAVファイルに保存して確認

3. **RMS値の閾値を確認**
   - 現在のRMS値（1-72）では、Google ASRが音声として認識しない可能性
   - 正常な音声ならRMS値は100以上になるはず

---

## 補足情報

- **エラー: なし**（`audioop`重複インポートエラーは解消済み）
- **診断ログ: 正常に出力されている**
- **音声データ処理: 正常に動作している**
- **問題: RMS値が低すぎる（1-72の範囲）**

**次のステップ:**
1. FreeSWITCHの音声ルーティング設定を確認
2. 実際の音声データをWAVファイルに保存して確認
3. RMS値が低い原因を特定

