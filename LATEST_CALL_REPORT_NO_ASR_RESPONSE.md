# 最新通話ログ調査報告書（「もしもし」に反応しない問題）

**調査日時**: 2025-12-27 20:02頃  
**対象通話ID**: `in-2025122720002635`  
**報告された問題**: 音声は流れたが「もしもし」に反応なし

---

## 【1. 通話開始時の状況】

### 通話開始フロー

1. **20:00:26.982**: `[CALL_START_TRACE] [LOC_START] Adding in-2025122720002635 to _active_calls (event_socket)`
2. **20:00:26.982**: `[INIT_SEQ] Queueing initial sequence for in-2025122720002635 (first time).`
3. **20:00:30.500**: `[ASR_DEBUG] Calling on_new_audio` - ASRへの音声送信開始
4. **20:00:30.501**: `[ASRHandler] Initialized for call_id=in-2025122720002635`
5. **20:00:30.501**: `[ASRHandler] Starting call handling for in-2025122720002635`

### 初期アナウンスの処理状況

**観察**:
- ✅ `[INIT_SEQ] Queueing initial sequence`ログは出力されている
- ❌ `[INIT_DEBUG]`ログが見つからない（`audio_paths`取得結果のログ）
- ❌ `[INIT_SEQ] Flag set`ログが見つからない（キュー追加成功後のログ）
- ❌ `initial greeting enqueued`ログが見つからない

**問題点**:
- 初期アナウンスの処理が完了していない可能性
- フラグがセットされていない可能性（キュー追加が失敗している可能性）

---

## 【2. ASRへの音声送信状況】

### 音声送信の確認

**RMS値の変化**:
- **20:00:30.566**: `rms=14` (初期)
- **20:00:30.717**: `rms=5666` (音声検出)
- **20:00:30.757**: `rms=5585` (音声検出)
- **20:00:30.918**: `rms=6660` (音声検出 - 最大値)
- **20:00:30.957**: `rms=5128` (音声検出)
- **20:00:31.117**: `rms=4353` (音声検出)
- **20:00:31.157**: `rms=3928` (音声検出)

**観察**:
- ✅ RMS値は高い（5000-6000程度）ので音声は検出されている
- ✅ `on_new_audio`は正常に呼ばれている
- ✅ `STREAMING_FEED`ログも正常に出力されている
- ✅ `QUEUE_PUT`ログも正常に出力されている（推測）

### ASRへの音声送信タイミング

**20:00:30.500-20:00:30.897**:
- 連続して`on_new_audio`が呼ばれている
- RMS値が高い（5000-6000程度）ので「もしもし」発話時の可能性が高い

---

## 【3. ASRレスポンスの確認】

### ASRレスポンスログの検索結果

**見つからないログ**:
- ❌ `[ASR_RAW_RES]`ログが見つからない
- ❌ `[ASR_TRANSCRIPT]`ログが見つからない
- ❌ `[ASR_GOOGLE_RAW]`ログが見つからない

**観察**:
- ASRへの音声送信は正常
- しかし、ASRからのレスポンスが来ていない
- Google Speech-to-Text APIからのレスポンスが来ていない可能性

---

## 【4. 初期アナウンス処理の詳細確認】

### 期待されるログ（修正後）

1. `[INIT_DEBUG] audio_paths=...` - audio_paths取得結果
2. `[INIT_DEBUG] Processing audio_path[0]=...` - 各ファイルの処理状況
3. `[INIT_DEBUG] Loaded audio_path[0]=...` - ファイル読み込み結果
4. `[INIT_SEQ] Flag set for ... Queued ... chunks.` - キュー追加成功後のログ

### 実際のログ

**見つかったログ**:
- ✅ `[INIT_SEQ] Queueing initial sequence for in-2025122720002635 (first time).`
- ❌ その他の`[INIT_DEBUG]`ログが見つからない
- ❌ `[INIT_SEQ] Flag set`ログが見つからない

**問題点**:
- `audio_paths`取得処理が実行されていない可能性
- または、`audio_paths`が空の可能性
- キューへの追加が失敗している可能性

---

## 【5. 現在のアクティブな通話本数】

### ログからの確認

**最新の`_active_calls`操作**:
- **20:00:26.982**: `[CALL_START_TRACE] [LOC_START] Adding in-2025122720002635 to _active_calls (event_socket)`
- **20:02:15.192**: `[CALL_END_TRACE] [LOC_02] Discarding call_id=in-2025122720002635 from _active_calls`
- **現在のアクティブな通話**: **0本**（通話は終了している）

---

## 【6. 問題の原因分析】

### 可能性のある原因

1. **初期アナウンス処理が完了していない**
   - `audio_paths`取得処理が実行されていない
   - または、`audio_paths`が空
   - キューへの追加が失敗している

2. **ASRストリームが開始されていない**
   - Google Speech-to-Text APIへの接続が確立されていない
   - ストリーム開始処理が失敗している
   - そのため、レスポンスが来ていない

3. **ASRが無効化されている**
   - 初期アナウンス再生中にASRが無効化されている可能性
   - `initial_sequence_playing`フラグが`True`のままになっている可能性

4. **音声送信タイミングの問題**
   - 「もしもし」発話時（20:00:30.717頃）にASRがまだ有効化されていない可能性
   - 初期アナウンス再生中にASRが無効化されている可能性

---

## 【7. 推奨事項】

### 1. 初期アナウンス処理の確認
- `[INIT_DEBUG]`ログが出力されているか確認
- `audio_paths`取得処理が実行されているか確認
- キューへの追加が成功しているか確認

### 2. ASRストリーム開始の確認
- GoogleASRのストリーム開始ログを確認
- ASRが有効化されているか確認
- `initial_sequence_playing`フラグの状態を確認

### 3. ASRレスポンスの確認
- `[ASR_RAW_RES]`ログが出力されているか確認
- Google Speech-to-Text APIからのレスポンスが来ているか確認
- エラーログがないか確認

### 4. タイミングの問題の確認
- 初期アナウンス再生中にASRが無効化されていないか確認
- 「もしもし」発話時にASRが有効化されているか確認

---

## 【8. 結論】

### 修正の効果
- ✅ 初期アナウンスは流れた（音声は再生された）
- ✅ ASRへの音声送信は正常（RMS値も高い）
- ❌ 初期アナウンス処理のログが見つからない（`[INIT_DEBUG]`ログ）
- ❌ ASRからのレスポンスが来ていない（`[ASR_RAW_RES]`ログ）

### 新たに発見された問題
1. **初期アナウンス処理のログが見つからない**
   - `[INIT_DEBUG]`ログが出力されていない
   - キューへの追加が失敗している可能性

2. **ASRからのレスポンスが来ていない**
   - `[ASR_RAW_RES]`ログが見つからない
   - Google Speech-to-Text APIからのレスポンスが来ていない可能性

3. **ASRが無効化されている可能性**
   - 初期アナウンス再生中にASRが無効化されている可能性
   - 「もしもし」発話時にASRが有効化されていない可能性

### 次のステップ
1. 初期アナウンス処理のログを確認（`[INIT_DEBUG]`ログが出力されているか）
2. ASRストリーム開始の確認（GoogleASRのストリーム開始ログ）
3. ASRレスポンスの確認（`[ASR_RAW_RES]`ログが出力されているか）
4. タイミングの問題の確認（初期アナウンス再生中にASRが無効化されていないか）

---

**報告者**: AI Assistant  
**報告日時**: 2025-12-27 20:02

