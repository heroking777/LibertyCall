# 最新通話ログ調査報告書（ご用件が2回流れる問題）

**調査日時**: 2025-12-27 19:50頃  
**対象通話ID**: `in-2025122719453262`  
**報告された問題**: 「ご用件をお伺いします」が2回流れる

---

## 【1. 修正の効果確認】

### ✅ ASR結果の受信確認

**`[ASR_RAW_RES]`ログの出力**:
```
2025-12-27 19:45:51,168 [WARNING] [ASR_RAW_RES] Response received. results=1 error_code=0 error_message=
2025-12-27 19:45:54,983 [WARNING] [ASR_RAW_RES] Response received. results=1 error_code=0 error_message=
2025-12-27 19:46:00,324 [WARNING] [ASR_RAW_RES] Response received. results=1 error_code=0 error_message=
```

**観察**:
- ✅ ASR結果が正常に返ってきている
- ✅ エラーコードは0（正常）
- ✅ 「もしもし」は正常に認識されている

### ✅ シーケンス番号の確認

**`[RTP_SEQ]`ログの出力**:
```
2025-12-27 19:45:44,494 [WARNING] [RTP_SEQ] Processing Seq=64900 for in-2025122719453262
2025-12-27 19:45:46,495 [WARNING] [RTP_SEQ] Processing Seq=65000 for in-2025122719453262
...
2025-12-27 19:45:57,215 [WARNING] [RTP_SEQ] Processing Seq=0 for in-2025122719453262
```

**観察**:
- ✅ シーケンス番号が正常に進んでいる
- ✅ 65535を超えた後、0にリセットされている（正常な動作）

---

## 【2. 通話開始時の状況】

### 通話開始フロー

1. **19:45:32.942**: `[FS_RTP_MONITOR] Mapped call_id=in-2025122719453262`
2. **19:45:34.976**: `[RTP_RECOVERY] [LOC_01]` - 自動登録
3. **19:45:34.976**: `[DEBUG_PRINT] _queue_initial_audio_sequence called`
4. **19:45:34.976**: `[DEBUG_PRINT] calling on_call_start`
5. **19:45:36.995**: `[PLAY_TTS] dispatching (initial) text='はい...'` - 初期音声シーケンス
6. **19:45:51.172**: `FLOW_ENGINE: phase=ENTRY->QA intent=UNKNOWN templates=['114']`
7. **19:45:51.179**: `[PLAY_TEMPLATE] template_id=114` - テンプレート114再生

---

## 【3. テンプレート再生の状況】

### 確認されたテンプレート再生

1. **19:45:36.995**: `[PLAY_TTS] dispatching (initial) text='はい...'`
   - 初期音声シーケンス（`_queue_initial_audio_sequence`）
   - テキスト: 「はい...」

2. **19:45:51.179**: `[PLAY_TEMPLATE] template_id=114`
   - FLOW_ENGINEによる再生
   - テンプレート114の内容: 「ご要件をもう一度お伺いしてもよろしいでしょうか？」

### 問題点

**ログ上では1回しか再生されていない**:
- テンプレート114は1回だけ再生されている
- 初期音声シーケンスは「はい...」が再生されている

**しかし、ユーザーは「ご用件をお伺いします」が2回流れると言っている**:
- テンプレート114の内容は「ご要件をもう一度お伺いしてもよろしいでしょうか？」であり、「ご用件をお伺いします」とは異なる
- 初期音声シーケンスの「はい...」も「ご用件をお伺いします」とは異なる

---

## 【4. テンプレート114の内容確認】

### テンプレート114の定義

**`/opt/libertycall/config/clients/000/templates.json`**:
```json
"114": {
  "text": "ご要件をもう一度お伺いしてもよろしいでしょうか？",
  "voice": "ja-JP-Neural2-B",
  "rate": 1.1
}
```

**観察**:
- テンプレート114の内容は「ご要件をもう一度お伺いしてもよろしいでしょうか？」
- ユーザーが聞いている「ご用件をお伺いします」とは異なる

---

## 【5. FLOW_ENGINEの動作確認】

### フェーズ遷移

**19:45:51.172**:
```
FLOW_ENGINE: call_id=in-2025122719453262 client_id=000 phase=ENTRY->QA intent=UNKNOWN templates=['114']
```

**観察**:
- ENTRYフェーズからQAフェーズへの遷移
- intent=UNKNOWNの場合、テンプレート114が選択されている
- テンプレート114は1回だけ再生されている

### flow.jsonの定義

**ENTRYフェーズのテンプレート**:
```json
"ENTRY": {
  "templates": ["004", "005"]
}
```

**QAフェーズのテンプレート**:
```json
"QA": {
  "templates": ["006_SYS", "010", "020", "021", "022", "023", "040", "041", "042", "060", "061", "062", "089", "090", "110"]
}
```

**観察**:
- ENTRYフェーズのテンプレートは["004", "005"]
- QAフェーズのテンプレートには114が含まれていない
- しかし、FLOW_ENGINEでテンプレート114が選択されている

---

## 【6. 初期音声シーケンスの内容確認】

### 初期音声シーケンスの再生

**19:45:36.995**: `[PLAY_TTS] dispatching (initial) text='はい...'`

**観察**:
- 初期音声シーケンスで「はい...」が再生されている
- これは`on_call_start`内でTTSキューに追加されている可能性

### 初期音声シーケンスのファイル

**`_queue_initial_audio_sequence`内**:
- `audio_manager.play_incoming_sequence(effective_client_id)`で音声ファイルのパスを取得
- 通常は000, 001, 002の順で再生される

**観察**:
- 初期音声シーケンスのログが不足している
- 実際に再生されている音声ファイルの内容が不明

---

## 【7. 問題の原因分析】

### 可能性のある原因

1. **初期音声シーケンスとFLOW_ENGINEの両方で同じ内容が再生されている**
   - 初期音声シーケンスに「ご用件をお伺いします」が含まれている可能性
   - FLOW_ENGINEでも同じ内容が再生されている可能性

2. **テンプレート114が2回再生されている**
   - ログ上では1回しか再生されていないが、実際には2回再生されている可能性
   - または、異なる経路から同じテンプレートが再生されている可能性

3. **初期音声シーケンスの内容が「ご用件をお伺いします」である**
   - 初期音声シーケンスの「はい...」が実際には「ご用件をお伺いします」という内容になっている可能性
   - または、初期音声シーケンスに別のテンプレートが含まれている可能性

---

## 【8. 現在のアクティブな通話本数】

### ログからの確認

**最新の`_active_calls`操作**:
- **19:45:34.976**: `[RTP_RECOVERY]` - 自動登録
- **19:46:03.173**: `[EVENT_SOCKET] Removed call_id=in-2025122719453262 from _active_calls`
- **現在のアクティブな通話**: **0本**（通話は終了している）

---

## 【9. 推奨事項】

### 1. 初期音声シーケンスの内容確認
- 初期音声シーケンスで実際に再生されている音声ファイルの内容を確認
- `audio_manager.play_incoming_sequence()`で取得されるファイルの内容を確認

### 2. テンプレート114の再生回数の確認
- テンプレート114が実際に2回再生されているか確認
- `[PLAY_TEMPLATE]`ログの出力回数を確認

### 3. FLOW_ENGINEのテンプレート選択ロジックの確認
- ENTRYフェーズからQAフェーズへの遷移時に、ENTRYフェーズのテンプレートが使用される可能性
- `_handle_flow_engine_transition`内のテンプレート選択ロジックを確認

### 4. ログの追加
- 初期音声シーケンスの再生内容をログに出力
- テンプレート再生の開始と終了をログに出力

---

## 【10. 結論】

### 修正の効果
- ✅ `[ASR_RAW_RES]`ログ: 正常に出力されている
- ✅ `[RTP_SEQ]`ログ: 正常に出力されている
- ✅ ASR結果: 正常に返ってきている
- ✅ 「もしもし」の認識: 正常に動作している

### 新たに発見された問題
1. **「ご用件をお伺いします」が2回流れる問題**
   - ログ上では、テンプレート114は1回だけ再生されている
   - 初期音声シーケンスは「はい...」が再生されている
   - しかし、ユーザーは「ご用件をお伺いします」が2回流れると言っている

2. **初期音声シーケンスの内容が不明**
   - 初期音声シーケンスのログが不足している
   - 実際に再生されている音声ファイルの内容が不明

### 次のステップ
1. 初期音声シーケンスの内容を確認（実際に再生されている音声ファイルの内容）
2. テンプレート114の再生回数を確認（ログの出力回数）
3. FLOW_ENGINEのテンプレート選択ロジックを確認（ENTRYフェーズからQAフェーズへの遷移時）

---

**報告者**: AI Assistant  
**報告日時**: 2025-12-27 19:50

