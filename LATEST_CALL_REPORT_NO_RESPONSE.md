# 最新通話ログ調査報告書（もしもし反応なし問題）

**調査日時**: 2025-12-27 19:45頃  
**対象通話ID**: `in-2025122719410572`  
**報告された問題**: 「もしもし数回言うも反応なし」

---

## 【1. 通話開始時の状況】

### 通話開始フロー

1. **19:41:05.239**: `[RTP_RECOVERY] [LOC_01]` - 自動登録
2. **19:41:05.240**: `[DEBUG_PRINT] _queue_initial_audio_sequence called`
3. **19:41:05.240**: `[DEBUG_PRINT] calling on_call_start`
4. **19:41:06.058**: `[ASR_DEBUG] Calling on_new_audio` - 最初の音声データ送信
5. **19:41:06.060**: `[ASRHandler] Initialized` - ASRハンドラー初期化

### 問題点

**`[RTP_DUP]`ログが出力されていない**:
- 重複チェックが機能していない可能性
- または、重複が発生していない（シーケンス番号が異なる）

---

## 【2. 音声データの処理状況】

### RMS値の推移

**初期（19:41:05-06）**:
- `rms=40`, `rms=6411`, `rms=10897`, `rms=7769`（有音検出）

**通話中（19:41:07-08）**:
- `rms=34`, `rms=4507`, `rms=5118`, `rms=8283`, `rms=10410`（有音検出）

**「もしもし」発話時（19:41:20-23）**:
- `rms=0`, `rms=36`, `rms=3977`, `rms=3034`, `rms=5178`, `rms=5135`, `rms=5822`, `rms=2735`（有音検出）
- ✅ 音声は正常に検出されている

**観察**:
- ✅ RMS値は正常に変動している
- ✅ 有音検出も正常に動作している
- ✅ 音声データは正常に処理されている

### `on_new_audio`の呼び出し状況

**19:41:24付近**:
- `[ASR_DEBUG] Calling on_new_audio`が20ms間隔で連続して呼ばれている
- 例: 19:41:24.240, 19:41:24.260, 19:41:24.280, ...

**観察**:
- ✅ 音声データは正常にASRに送信されている
- ✅ 呼び出し頻度は正常（20ms間隔は正常なRTPパケット間隔）

---

## 【3. 重大な問題: `[DEBUG_INIT] no_input_timer`の頻繁な呼び出し】

### 問題の詳細

**19:41:06付近**:
```
19:41:06.120: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
19:41:06.123: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
19:41:06.127: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
19:41:06.130: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
19:41:06.138: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
19:41:06.178: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
19:41:06.221: [DEBUG_INIT] no_input_timer started (timeout=10.0s)
...
```

**問題点**:
- `no_input_timer`が**非常に頻繁に**（数ミリ秒ごとに）再起動されている
- これは、音声入力があるたびにタイマーがリセットされていることを示している
- しかし、ASR結果が返されていない可能性

### 統計

- `[DEBUG_INIT] no_input_timer started`の呼び出し回数: **187回**
- これは、音声入力があるたびにタイマーがリセットされていることを示している

---

## 【4. ASR結果の確認】

### ASR結果ログ

**確認結果**: **ASR結果のログが見つからない**
- `ASR_TRANSCRIPT`ログ: 見つからない
- `ASR_GOOGLE_RAW`ログ: 見つからない
- `transcript`や`recognition`を含むログ: 見つからない

**観察**:
- ✅ 音声データは正常にASRに送信されている
- ❌ ASR結果が返されていない
- ❌ これが「もしもし数回言うも反応なし」の直接原因

---

## 【5. 重複チェックの状況】

### `[RTP_DUP]`ログ

**確認結果**: **ログが見つからない**
- 重複チェックが機能していない可能性
- または、重複が発生していない（シーケンス番号が異なる）

**可能性**:
1. シーケンス番号が正常に増加しているため、重複が発生していない
2. 重複チェックのロジックに問題がある
3. `effective_call_id`が確定する前にシーケンス番号チェックが行われている

---

## 【6. 現在のアクティブな通話本数】

### ログからの確認

**最新の`_active_calls`操作**:
- **19:41:05.239**: `[RTP_RECOVERY]` - 自動登録
- **現在のアクティブな通話**: **0本**（通話は終了している）

---

## 【7. 問題の原因分析】

### 主要な問題

1. **ASR結果が返されていない**
   - 音声データは正常にASRに送信されている
   - しかし、ASR結果（transcript）が返されていない
   - これが「もしもし数回言うも反応なし」の直接原因

2. **`no_input_timer`の頻繁な再起動**
   - 音声入力があるたびにタイマーがリセットされている
   - これは正常な動作の可能性もあるが、ASR結果が返されないため問題が発生している

3. **重複チェックの動作確認**
   - `[RTP_DUP]`ログが出力されていない
   - 重複が発生していない可能性、または重複チェックが機能していない可能性

### 可能性のある原因

1. **ASR APIの接続問題**
   - Google ASR APIへの接続が正常に確立されていない
   - 認証情報の問題

2. **ASR設定の問題**
   - 言語設定が正しくない
   - サンプルレートの設定が正しくない

3. **ASR結果の処理問題**
   - ASR結果が返されているが、ログに出力されていない
   - ASR結果の処理ロジックに問題がある

---

## 【8. 推奨事項】

### 1. ASR結果の確認
- ASR APIの接続状態を確認
- ASR結果が返されているか確認（別のログファイルを確認）
- ASR設定（言語、サンプルレート等）を確認

### 2. `no_input_timer`の動作確認
- タイマーの再起動ロジックを確認
- 音声入力検出時のタイマーリセットが適切か確認

### 3. 重複チェックの動作確認
- `[RTP_DUP]`ログが出力されない理由を確認
- シーケンス番号の取得と比較ロジックを確認

### 4. ログの追加
- ASR結果を受信した際のログを追加
- ASR APIへの接続状態を確認するログを追加

---

## 【9. 結論】

### 修正の効果
- ✅ `[RTP_RECOVERY]`ログ: 正常に動作している
- ✅ `[AUDIO_DEBUG]`ログ: 正常に出力されている
- ✅ RMS値: 正常に変動している
- ✅ 音声データの送信: 正常に動作している
- ❌ ASR結果: 返されていない（これが主要な問題）

### 新たに発見された問題
1. **ASR結果が返されていない**
   - 音声データは正常にASRに送信されているが、結果が返されていない
   - これが「もしもし数回言うも反応なし」の直接原因

2. **`no_input_timer`の頻繁な再起動**
   - 音声入力があるたびにタイマーがリセットされている
   - ASR結果が返されないため、問題が発生している

3. **重複チェックの動作確認**
   - `[RTP_DUP]`ログが出力されていない
   - 重複が発生していない可能性、または重複チェックが機能していない可能性

### 次のステップ
1. ASR APIの接続状態を確認
2. ASR結果が返されているか確認（別のログファイルを確認）
3. ASR設定（言語、サンプルレート等）を確認
4. ASR結果を受信した際のログを追加

---

**報告者**: AI Assistant  
**報告日時**: 2025-12-27 19:45

