# LibertyCall プロジェクト - Cursor エージェントモード用ルール

> このファイルは Cursor エージェントモード全体に適用されるルールです。
> すべての AI アシスタントがこのルールに従って動作します。

## 🔧 ワンライナー出力ルール

以後、診断・ログ監視・再起動・確認系のコマンドは、**必ずワンライナー形式で提示すること**。

複数の `tail`, `grep`, `tcpdump`, `fs_cli` などは `&&` または `;` で結合して1行で実行できる形にする。

再起動とログ監視を同時に実行する場合も `&` や `sleep` を用いてワンライナー化する。

**例：**
```bash
pkill -f realtime_gateway.py && cd /opt/libertycall && python3 gateway/realtime_gateway.py & sleep 1 && tail -Fn0 /tmp/gateway_restart.log | grep -E "RTP_RECV|ASR"
```

ログ出力が複数ファイルに分かれている場合も、`tail -Fn0 file1 file2 | grep -E "..."` で一括確認できるようにする。

**複数コマンドを順番に説明する形式は禁止。常に1行で即実行できる形式を原則とする。**

> "もう説明じゃなく、現場で叩ける形で出せ"

## 1. ポート番号変更時の注意事項

### 🚫 絶対に守ること

1. **ポート番号を変更する前に、必ず `/opt/libertycall/docs/project_tree.txt` の「ポート使用状況一覧」セクション（504行目以降）を確認する**
2. **既存のポート番号が設定されている場合は、勝手に変更しない。既存の設定を尊重する**
3. **ポート番号を変更する必要がある場合は、必ずユーザーに確認を取ってから変更する**
4. **既存のポートと競合すると、システムが停止する可能性があるため、使用中のポートを避ける**
5. **ポート変更後は、この一覧を更新する（追記のみ、上書き禁止）**
6. **古いポート情報は削除せず、「（旧）」などのマークを付けて残す**

### 現在使用中の主要ポート

- 80, 443: Nginx (HTTP/HTTPS)
- 8000: MCP (Model Context Protocol)
- 8001: Console Backend (FastAPI)
- 3000: Project State Backend
- 7002, 9001: Gateway
- 5173: 開発用 (Vite)

---

## 2. AIアシスタント向け編集ルール

### 2.1 絶対守ること

1. **コードが常に真実であり、ドキュメントは補助にすぎない**
   - 仕様書とコードが矛盾した場合 → **コードを優先** し、ドキュメント側を修正すること

2. **自由会話（LLM対話）を通話本番ルートにねじ込まない**
   - LLM を使うときは、必ず「ログ分析」や「設計補助」で使うに留める

3. **TTS はデフォルトで "非ストリーミング"**
   - `LC_TTS_STREAMING=0` 前提のコードを壊さない

4. **ASR プロバイダ変更は大工事扱い**
   - Whisper / 他社 ASR などへの切り替えは、勝手にやらない

### 2.2 変更してよい範囲（例）

- ログメッセージの追加・改善
- 超軽微なリファクタ（関数分割・命名整理など）
- if 分岐用のルール追加（ただしルール定義ファイルの仕様に従うこと）
- TTS の速度・話速・声質の **設定値変更だけ**（Google TTS のパラメータ調整）

### 2.3 責務分離を壊さない

- 設定変更 → `clients/{id}/config.json`
- ルール変更 → `clients/{id}/rules.json`
- 音声変換 → `audio_utils`
- 意図判定 → `ai_core / rules`
- 通信ロジック → `realtime_gateway`
- ARI制御 → `liberty_rt`

### 2.4 絶対禁止事項

- 電話番号のハードコード
- intentキーワードを `realtime_gateway.py` に書く
- 設定ファイルを直接 `open()` する
- ASR/TTS のコードを弄る（`ai_core` に任せる）

---

## 3. 不明点・TODO の扱い

- 「多分こうだろう」で書かないこと
- 分からないときは **コメントかドキュメントに "TODO / 要確認" と明記** する
- わからない部分は「不明」と書く方が正解（推測や憶測の仕様は避ける）

---

## 4. ドキュメント更新ルール

- 構成が大きく変わったら：
  1. 先にコードを更新
  2. それに合わせてドキュメントを**短く・最新状態に**書き換える
- ドキュメントは「AI同士の引き継ぎメモ」として、常に最新・安全な状態に保つ

---

## 5. プロジェクトの基本方針

- プロダクト名: **LibertyCall**
- 現在のフェーズ: **Phase 1 – ルールベース if 分岐型 AI電話**
- 会話ポリシー:
  - 想定されたフレーズ・パターンだけを扱う
  - 想定外の発話はすべて「担当者に繋ぐ」側に寄せる
  - 想定外が見つかれば、ルール・台本を後から追加する運用
  - **自由会話・LLM対話はやらない**（誤案内・クレーム防止のため）

---

## 6. 重要なファイルの役割

- `gateway/realtime_gateway.py`: RTP 受信・送信、音声バッファ、RMS、区間検出
- `gateway/ai_core.py`: GoogleASR ラッパー、ルール判定、Google TTS
- `config/`: ASR プロバイダ、TTS モード、RTP ポートなどの設定
- `clients/{id}/config.json`: クライアント別設定
- `clients/{id}/rules.json`: クライアント別ルール

---

## 7. ポート情報の更新方法

ポート情報を更新する際は：
1. `/opt/libertycall/docs/project_tree.txt` の「ポート使用状況一覧」セクションを編集
2. **既存の記載を削除せず、追記のみ行う**
3. 古いポート情報は「（旧）」などのマークを付けて残す
4. 更新日時を更新する

---

## 8. その他の注意事項

- 日本語で応答すること
- コード変更時は、必ず既存の動作を確認してから変更すること
- 大きな変更を行う場合は、必ずユーザーに確認を取ること
- テストや検証が必要な変更は、必ず実行前に確認すること

